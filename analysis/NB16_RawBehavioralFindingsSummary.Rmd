---
title: 'Experience vs. description based decision-making project: Raw behavioral findings'
output:
  html_document:
    toc: yes
    toc_float: yes
    code_folding: 'hide'
  pdf_document:
    toc: yes
---

# Set up

```{r include=FALSE}
library(broom)
library(tidyverse)
theme_set(theme_bw())
library(here)
cbbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
helpers_path = here('analysis/helpers/')
source(paste0(helpers_path,'01_clean_behavioral_data.R'))
```

```{r}
source(paste0(helpers_path,'01_clean_behavioral_data.R'))
```

```{r}
clean_beh_data = clean_beh_data %>%
  mutate(EVRight = referenceProb * referenceValue,
         EVLeft = lotteryValue * lotteryProb,
         conflictTrial = ifelse( (EVLeft<EVRight) & (fractalLeftProb>fractalRightProb), "conflict", ifelse( (EVLeft>EVRight) & (fractalLeftProb<fractalRightProb), "conflict", "no conflict")), #this puts all EVLeft == EVRight trials into the no conflict bin
         leftLotteryBetter = EVLeft-EVRight>0,
         leftFractalBetter = (fractalLeftProb)-(fractalRightProb)>0,
         lotteriesSame = EVLeft == EVRight,
         fractal_diff = abs(fractalLeftProb - fractalRightProb),
         lottery_ev_diff = round(abs(EVLeft - EVRight),3),
         lottery_ev_diff = ifelse(lottery_ev_diff ==0, "no EV diff", ifelse(lottery_ev_diff == .2, "small EV diff", ifelse(lottery_ev_diff == .4, "large EV diff", NA))),
         lottery_ev_diff = factor(lottery_ev_diff, levels=c("no EV diff", "small EV diff", "large EV diff"), labels = c("no", "small", "large")),
         choseBetterLotteryBundle = ifelse(leftLotteryBetter & choiceLeft == 1, 1, ifelse(!leftLotteryBetter & choiceLeft == 0, 1, 0)),
         choseBetterFractalBundle = ifelse(leftFractalBetter & choiceLeft == 1, 1, ifelse(!leftFractalBetter & choiceLeft == 0, 1, 0)),
         leftBundleValue = (probFractalDraw*fractalLeftProb) + ((1-probFractalDraw)*EVLeft),
         rightBundleValue = (probFractalDraw * fractalRightProb) + ((1-probFractalDraw)*EVRight),
         leftBundleBetter = leftBundleValue > rightBundleValue,
         choseBetterOverallBundle = ifelse(leftBundleBetter & choiceLeft == 1, 1, ifelse(!leftBundleBetter & choiceLeft == 0, 1, 0)),
         logRt = log(reactionTime),
         probFractalDraw = as.factor(probFractalDraw))
```

```{r}
fig_out_path = paste0(here(), '/outputs/fig/')
```

# Choice

**Analyzing choice without using any model-based measures**

## Side

Proportion of left choice by probFractalDraw for all subjects. No systematic idiosyncratic side bias.

```{r}
p = clean_beh_data %>%
  group_by(subnum, probFractalDraw, conflictTrial) %>%
  summarise(.groups = "keep",
            propLeft = sum(choiceLeft)/n()) %>%
  ggplot(aes(probFractalDraw, propLeft))+
  geom_boxplot()+
  # geom_jitter(height=0, width=.1, alpha=.5, aes(color=as.numeric(subnum)))+
  geom_hline(yintercept=.5, color="gray")+
  theme(legend.position = "none")+
  facet_grid(conflictTrial~.)+
  labs(x="p(Fractal)", y="Proportion of left choice")

ggsave(file=paste0(fig_out_path, 'prop_left_choice.jpg'), p, height = 5, width=8, units="in")
p

```

## Choice based on lottery, fractal, bundle value

When the lotteries don't have the same EV do subjects choose the bundle with the better lottery? This should depend on how much the reward depends on the lotteries. Subject do choose the bundle with the better lottery more frequently when it matters for the reward. They appropriately choose it less frequently when the reward depends more on the fractals and the fractals suggest a different bundle to be the better one (conflict trials)

Do they get better with time?  
- Some improvement for pFracDraw <=.5 especially from run 1 to run 2
- Even for pFracDraw <= .5 trials no conflict trials are slightly worse than conflict trials.
- For trials where fractals matter more for the reward (pFracDraw > .5) performance is worse in both types of conflict trials. In conflict trials the drop for choosing the bundle with the better lottery is not as sharp as it should be and in no conflict trials choice of bundle with better lottery is not as high even though it is also the bundle with the better fractal.  


```{r}
p = clean_beh_data %>%
  mutate(session = paste0("run ", session),
         choseBetterLotteryBundle = ifelse(EVRight == EVLeft, NA, choseBetterLotteryBundle),
         choseBetterOverallBundle = ifelse(leftBundleValue == rightBundleValue, NA, choseBetterOverallBundle)) %>%
  group_by(probFractalDraw, conflictTrial, session) %>%
  summarise(.groups="keep",
            prop_choseBetterLotteryBundle = mean(choseBetterLotteryBundle, na.rm=T),
            sem_choseBetterLotteryBundle = sd(choseBetterLotteryBundle, na.rm=T)/sqrt(n()),
            prop_choseBetterFractalBundle = mean(choseBetterFractalBundle),
            sem_choseBetterFractalBundle = sd(choseBetterFractalBundle)/sqrt(n()),
            prop_choseBetterOverallBundle = mean(choseBetterOverallBundle, na.rm=T),
            sem_choseBetterOverallBundle = sd(choseBetterOverallBundle, na.rm=T)/sqrt(n())) %>%
    gather(prop_type, prop_value, -probFractalDraw, -conflictTrial, -session,-sem_choseBetterLotteryBundle ,-sem_choseBetterFractalBundle, -sem_choseBetterOverallBundle) %>%
  gather(sem_type, sem_value,  -probFractalDraw, -conflictTrial, -session, -prop_type, -prop_value) %>%
  ggplot(aes(probFractalDraw, prop_value, color=prop_type))+
  geom_point(alpha=.5)+
  geom_errorbar(aes(ymin = prop_value-sem_value,
                    ymax = prop_value+sem_value), width=.2)+
  geom_hline(aes(yintercept=.5), color="grey")+
  facet_grid(conflictTrial~session)+
  theme(legend.position = "bottom")+
  labs(color="", x="p(Fractal)", y="Proportion of choices")+
  scale_color_manual(values=c(cbbPalette[1:2], "purple"),
                     breaks = c("prop_choseBetterFractalBundle", "prop_choseBetterLotteryBundle", "prop_choseBetterOverallBundle"),
                     labels = c(c("Better Fractal Bundle", "Better Lottery Bundle", "Better Overall Bundle")))+
  scale_x_discrete(breaks = c("0", "0.2", "0.4", "0.6", "0.8", "1"))+
  ylim(0,1)

ggsave(file=paste0(fig_out_path, 'prop_better_choice.jpg'), p, height = 5, width=10, units="in")
p
```

```{r warning=FALSE, message=FALSE}
p = clean_beh_data %>%
  mutate(session = paste0("run ", session),
         choseBetterLotteryBundle = ifelse(EVRight == EVLeft, NA, choseBetterLotteryBundle),
         choseBetterOverallBundle = ifelse(leftBundleValue == rightBundleValue, NA, choseBetterOverallBundle)) %>%
  group_by(probFractalDraw, conflictTrial, session) %>%
  summarise(.groups="keep",
            prop_choseBetterLotteryBundle = mean(choseBetterLotteryBundle, na.rm=T),
            sem_choseBetterLotteryBundle = sd(choseBetterLotteryBundle, na.rm=T)/sqrt(n()),
            prop_choseBetterFractalBundle = mean(choseBetterFractalBundle),
            sem_choseBetterFractalBundle = sd(choseBetterFractalBundle)/sqrt(n()),
            prop_choseBetterOverallBundle = mean(choseBetterOverallBundle, na.rm=T),
            sem_choseBetterOverallBundle = sd(choseBetterOverallBundle, na.rm=T)/sqrt(n())) %>%
    gather(prop_type, prop_value, -probFractalDraw, -conflictTrial, -session,-sem_choseBetterLotteryBundle ,-sem_choseBetterFractalBundle, -sem_choseBetterOverallBundle) %>%
  gather(sem_type, sem_value,  -probFractalDraw, -conflictTrial, -session, -prop_type, -prop_value) %>%
  mutate(prop_value = ifelse(session == "run 1", prop_value, NA),
         sem_value = ifelse(session == "run 1", sem_value, NA)) %>%
  ggplot(aes(probFractalDraw, prop_value, color=prop_type))+
  geom_point(alpha=.5)+
  geom_errorbar(aes(ymin = prop_value-sem_value,
                    ymax = prop_value+sem_value), width=.2)+
  geom_hline(aes(yintercept=.5), color="grey")+
  facet_grid(conflictTrial~session)+
  theme(legend.position = "bottom")+
  labs(color="", x="p(Fractal)", y="Proportion of choices")+
  scale_color_manual(values=c(cbbPalette[1:2], "purple"),
                     breaks = c("prop_choseBetterFractalBundle", "prop_choseBetterLotteryBundle", "prop_choseBetterOverallBundle"),
                     labels = c(c("Better Fractal Bundle", "Better Lottery Bundle", "Better Overall Bundle")))+
  scale_x_discrete(breaks = c("0", "0.2", "0.4", "0.6", "0.8", "1"))+
  ylim(0,1)

ggsave(file=paste0(fig_out_path, 'prop_better_choice_build.jpg'), p, height = 5, width=10, units="in")
```

## Logit analysis with true values 

```{r}
p = clean_beh_data %>%
  select(EVLeft, EVRight, fractalLeftProb, fractalRightProb, probFractalDraw, choiceLeft) %>%
  mutate(EVDiff = scale(EVLeft - EVRight), 
         fractalDiff = scale(fractalLeftProb - fractalRightProb)) %>%
  nest(data = -probFractalDraw) %>% 
  mutate(
    fit = map(data, ~ glm(choiceLeft ~ EVDiff + fractalDiff, data = .x, family=binomial(link="logit"))),
    tidied = map(fit, tidy)
  ) %>% 
  unnest(tidied) %>%
  filter(term != "(Intercept)") %>%
  select(probFractalDraw, term, estimate, std.error) %>%
  mutate(term = ifelse(term == "EVDiff", "Lottery EV difference", ifelse(term == "fractalDiff", "Fractal probability difference", NA))) %>%
  ggplot(aes(probFractalDraw, estimate, col=term, group=term))+
      geom_point()+
      geom_line()+
      geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate +std.error), width=0.2)+
      geom_hline(aes(yintercept=0), linetype="dashed")+
      scale_color_manual(values = cbbPalette[1:2])+
      theme(legend.position = "bottom")+
      labs(color="", y="Logit slope estimate", x="p(Fractal)")

ggsave(file=paste0(fig_out_path, 'group_logit.jpg'), p, height = 5, width=8, units="in")
p
```

Individual differences in this pattern are very large. The pattern doesn't really exist clearly for any subject.

```{r warning=FALSE, message=FALSE}
tmp = clean_beh_data %>%
  select(subnum, EVLeft, EVRight, fractalLeftProb, fractalRightProb, probFractalDraw, choiceLeft) %>%
  mutate(EVDiff = scale(EVLeft - EVRight), 
         fractalDiff = scale(fractalLeftProb - fractalRightProb)) %>%
  nest(data = -c(probFractalDraw, subnum)) %>% 
  mutate(
    fit = map(data, ~ glm(choiceLeft ~ EVDiff + fractalDiff, data = .x, family=binomial(link="logit"))),
    tidied = map(fit, tidy)
  ) %>% 
  unnest(tidied) %>%
  filter(term != "(Intercept)") %>%
  select(subnum, probFractalDraw, term, estimate, std.error)
```

```{r warning=FALSE, message=FALSE}
p = tmp %>% ggplot(aes(probFractalDraw, estimate, col=term, group=term))+
      geom_point()+
      geom_line()+
      geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate +std.error), width=0.2)+
      geom_hline(aes(yintercept=0), linetype="dashed")+
      scale_color_manual(values = cbbPalette[2:1])+
      theme(legend.position = "none")+
      labs(color="") +
  facet_wrap(~subnum, scales="free")+
  ylim(-5, 5)+
  labs(x="", y="")

ggsave(file=paste0(fig_out_path, 'ind_diff_logit.jpg'), p, height = 9, width=16, units="in")
p
```

## Perseverance of choice 

When reward depends more on fractals and the previous trial was rewarded based on the fractals then subjects are more likely to choose the side they chose previously. Makes sense. Suggestive of learning and understanding of task.

```{r}
p = clean_beh_data %>%
  select(subnum, trialNum, choiceLeft, reward, fractalDraw, probFractalDraw) %>%
  group_by(subnum) %>% # so the last choice for one subject does not bleed into the first choice of the next subject
  mutate(lastChoiceSide = lag(choiceLeft),
         lastFractalDraw = lag(fractalDraw),
         choseLastSide = choiceLeft == lastChoiceSide,
         lastTrialRewarded = paste0("Last Trial rewarded: ", lag(reward > 0))) %>%
  filter(trialNum > 1) %>% #remove first trial of each run
  drop_na() %>% #for two subjects there are cases when trialNum == 1 is cleaned because there was no response. These lead to NAs in lastChoiceSide and lastFractalDraw so they are dropped
  ungroup()%>%
  group_by(lastFractalDraw, lastTrialRewarded, probFractalDraw) %>%
  summarise(.groups='keep',
            prop_choseLastSide = mean(choseLastSide, na.rm=T),
            sem_choseLastSide = sd(choseLastSide, na.rm=T)/sqrt(n())) %>%
  mutate(lastRewardAttribute = ifelse(lastFractalDraw == 1, "fractal", "lottery")) %>%  
  ggplot(aes(probFractalDraw, prop_choseLastSide, color=lastRewardAttribute))+
  geom_point(position = position_dodge(width=.5))+
  geom_errorbar(aes(ymin=prop_choseLastSide-sem_choseLastSide, ymax=prop_choseLastSide+sem_choseLastSide), width=.2, position=position_dodge(width=.5))+
  geom_hline(aes(yintercept=.5), color="gray")+
  facet_grid(lastTrialRewarded~.)+
  theme(legend.position = "bottom")+
  labs(x= "p(Fractal)", y = "Proportion of repeated choice", color="Last rewarded attribute")+
  scale_color_manual(values=cbbPalette[1:2],
                     breaks = c("fractal", "lottery"),
                     labels = c("Fractal", "Lottery"))

ggsave(file=paste0(fig_out_path, 'perseverance_of_choice.jpg'), p, height = 5, width=8, units="in")
p
  
```

## Learning of fractal values

what do the drifting reward probabilities look like
is there a good signal to learn?

should I model "learning" for the whole task?

```{r}
clean_beh_data %>%
  group_by(subnum) %>%
  mutate(trialNum = 1:n()) %>%
  select(fractalLeftProb, fractalRightProb, trialNum, subnum) %>%
  gather(key, value, -trialNum, -subnum) %>%
  ggplot(aes(trialNum, value, color=key))+
  geom_line()+
  geom_vline(xintercept=60, color="gray")+
  geom_vline(xintercept=120, color="gray")+
  geom_vline(xintercept=180, color="gray")+
  geom_vline(xintercept=240, color="gray")+
  facet_wrap(~subnum)+
  theme(legend.position = "bottom",
        legend.title=element_blank())


```
Are you more likely to choose the better fractal bundle as trialnum increases

```{r}
clean_beh_data %>%
  mutate(session = paste0("run ", session)) %>%
  ggplot(aes(trialNum, choseBetterFractalBundle))+
  geom_smooth(formula = 'y~x', method = "glm", method.args = list(family=binomial), fullrange=TRUE, color=cbbPalette[3], alpha=.75)+
  geom_line(aes(group=subnum),stat='smooth',formula = 'y~x', method = "lm",se=FALSE, alpha=.1, size=1)+
  facet_grid(.~session)+
  labs(x = "Trial Number", y="Choice of fractal with higher objective reward probability")
```
Are you more likely to choose the better fractal bundle as trialnum increases for trials where the fractals matter more for the reward?

```{r}
clean_beh_data %>%
  filter(as.numeric(as.character(probFractalDraw))>.5) %>%
  mutate(session = paste0("run ", session)) %>%
  ggplot(aes(trialNum, choseBetterFractalBundle))+
  geom_smooth(formula = 'y~x', method = "glm", method.args = list(family=binomial), fullrange=TRUE, color=cbbPalette[3], alpha=.75)+
  geom_line(aes(group=subnum),stat='smooth',formula = 'y~x', method = "lm",se=FALSE, alpha=.1, size=1)+
  facet_grid(.~session)+
  labs(x = "Trial Number", y="Choice of fractal with higher objective reward probability", title="For p(Fractal)>.5")
```
Maybe choice of objectively better bundle is not revealing learning because subjects don't know this but only know how frequently a fractal is rewarded.  

Are they more likely to choose the bundle with the fractal that has been rewarded more frequently? Yes, when fractals matter more for the reward.

```{r}
clean_beh_data %>%
  group_by(subnum, session) %>%
  mutate(numLeftFractalRewarded = cumsum(leftFractalReward),
         numRightFractalRewarded = cumsum(rightFractalReward),
         choseMoreRewardedFractal = ifelse((numLeftFractalRewarded> numRightFractalRewarded) & (choiceLeft==1), TRUE, ifelse((numRightFractalRewarded>numLeftFractalRewarded) & (choiceLeft==0), TRUE, FALSE))) %>%
  group_by(probFractalDraw) %>%
  summarise(mean_choseMoreRewardedFractal = mean(choseMoreRewardedFractal), 
            sem_choseMoreRewardedFractal = sd(choseMoreRewardedFractal)/sqrt(n()))%>%
  ggplot(aes(probFractalDraw, mean_choseMoreRewardedFractal))+
  geom_point()+
  geom_errorbar(aes(ymin=mean_choseMoreRewardedFractal-sem_choseMoreRewardedFractal, ymax=mean_choseMoreRewardedFractal+sem_choseMoreRewardedFractal), width=.2)+
  geom_hline(aes(yintercept = .5), color="gray")+
  labs(x="p(Fractal)", y="Choice of more frequently rewarded fractal")
```

For trials where they on average choose the more frequently rewarded fractal does this choice change throughout the run?

```{r}
clean_beh_data %>%
  group_by(subnum, session) %>%
  mutate(numLeftFractalRewarded = cumsum(leftFractalReward),
         numRightFractalRewarded = cumsum(rightFractalReward),
         choseMoreRewardedFractal = ifelse((numLeftFractalRewarded> numRightFractalRewarded) & (choiceLeft==1), 1, ifelse((numRightFractalRewarded>numLeftFractalRewarded) & (choiceLeft==0), 1, 0))) %>%
  ungroup() %>%
  filter(as.numeric(as.character(probFractalDraw))>.5) %>%
  mutate(session = paste0("run ", session)) %>%
  ggplot(aes(trialNum, choseMoreRewardedFractal))+
  geom_smooth(formula = 'y~x', method = "glm", method.args = list(family=binomial), fullrange=TRUE, color=cbbPalette[3], alpha=.75)+
  geom_line(aes(group=subnum),stat='smooth',formula = 'y~x', method = "lm",se=FALSE, alpha=.1, size=1)+
  facet_grid(.~session)+
  labs(x = "Trial Number", y="Choice of more frequently rewarded fractal", title="For p(Fractal)>.5")
```

This holds if you don't filter for the trials where fractal isn't more relevant for the reward as well.

```{r}
clean_beh_data %>%
  group_by(subnum, session) %>%
  mutate(numLeftFractalRewarded = cumsum(leftFractalReward),
         numRightFractalRewarded = cumsum(rightFractalReward),
         choseMoreRewardedFractal = ifelse((numLeftFractalRewarded> numRightFractalRewarded) & (choiceLeft==1), 1, ifelse((numRightFractalRewarded>numLeftFractalRewarded) & (choiceLeft==0), 1, 0))) %>%
  ungroup() %>%
  mutate(session = paste0("run ", session)) %>%
  ggplot(aes(trialNum, choseMoreRewardedFractal))+
  geom_smooth(formula = 'y~x', method = "glm", method.args = list(family=binomial), fullrange=TRUE, color=cbbPalette[3], alpha=.75)+
  geom_line(aes(group=subnum),stat='smooth',formula = 'y~x', method = "lm",se=FALSE, alpha=.1, size=1)+
  facet_grid(.~session)+
  labs(x = "Trial Number", y="Choice of more frequently rewarded fractal")
```

```{r}
clean_beh_data %>%
  mutate(session = paste0("run ", session),
         choseBetterLotteryBundle = ifelse(EVRight == EVLeft, NA, choseBetterLotteryBundle),
         choseBetterOverallBundle = ifelse(leftBundleValue == rightBundleValue, NA, choseBetterOverallBundle)) %>%
  group_by(subnum, session) %>%
  mutate(numLeftFractalRewarded = cumsum(leftFractalReward),
         numRightFractalRewarded = cumsum(rightFractalReward),
         choseMoreRewardedFractal = ifelse((numLeftFractalRewarded> numRightFractalRewarded) & (choiceLeft==1), 1, ifelse((numRightFractalRewarded>numLeftFractalRewarded) & (choiceLeft==0), 1, 0))) %>%
  ungroup() %>%
  group_by(probFractalDraw, conflictTrial, session) %>%
  summarise(.groups="keep",
            prop_choseBetterLotteryBundle = mean(choseBetterLotteryBundle, na.rm=T),
            sem_choseBetterLotteryBundle = sd(choseBetterLotteryBundle, na.rm=T)/sqrt(n()),
            prop_choseMoreRewardedFractalBundle = mean(choseMoreRewardedFractal),
            sem_choseMoreRewardedFractalBundle = sd(choseMoreRewardedFractal)/sqrt(n()),
            prop_choseBetterFractalBundle = mean(choseBetterFractalBundle),
            sem_choseBetterFractalBundle = sd(choseBetterFractalBundle)/sqrt(n()),
            prop_choseBetterOverallBundle = mean(choseBetterOverallBundle, na.rm=T),
            sem_choseBetterOverallBundle = sd(choseBetterOverallBundle, na.rm=T)/sqrt(n())) %>%
    gather(prop_type, prop_value, -probFractalDraw, -conflictTrial, -session,-sem_choseBetterLotteryBundle ,-sem_choseMoreRewardedFractalBundle, -sem_choseBetterFractalBundle, -sem_choseBetterOverallBundle) %>%
  gather(sem_type, sem_value,  -probFractalDraw, -conflictTrial, -session, -prop_type, -prop_value) %>%
  ggplot(aes(probFractalDraw, prop_value, color=prop_type))+
  geom_point(alpha=.5)+
  geom_errorbar(aes(ymin = prop_value-sem_value,
                    ymax = prop_value+sem_value), width=.2)+
  geom_hline(aes(yintercept=.5), color="grey")+
  facet_grid(conflictTrial~session)+
  theme(legend.position = "bottom")+
  labs(color="", x="p(Fractal)", y="Proportion of choices")+
  scale_color_manual(values=c("red", cbbPalette[1:2], "purple"),
                     breaks = c("prop_choseMoreRewardedFractalBundle","prop_choseBetterFractalBundle", "prop_choseBetterLotteryBundle", "prop_choseBetterOverallBundle"),
                     labels = c(c("More Rewarded Fractal Bundle", "Better Fractal Bundle", "Better Lottery Bundle", "Better Overall Bundle")))+
  scale_x_discrete(breaks = c("0", "0.2", "0.4", "0.6", "0.8", "1"))+
  ylim(0,1)
```

Relevance of attribute changes randomly in each trial and there is a lot going on on the reward screen
Ideally subjects would pay equal attention to both fractals and update the QValue for each
But they might have a "good/bad" fractal signal that fades if in the next few trials the fractal is not relevant.
How to check for this?

```{r}
  
```

### Differential learning 

more learning for rewarded side? 
more chosen bundle fractal?
more learning from rare events? E.g. if the fractaldraw wasn't likely but happened anyway?

```{r}
  
```


## Risk attitude

This is a focus when studying the description-experience gap. 
In description-based choice subjects are risk averse in gains and risk seeking in losses.
In experience-based choice this flips and subjects are risk seeking in gains and risk averse in losses.

Risk attitude in description based choice: Risk aversion but this is based on a very limited number of trials

```{r}
clean_beh_data %>%
  filter(lotteriesSame == 1) %>%
  group_by(probFractalDraw) %>%
  summarise(.groups = "keep",
            mean_choiceRef = mean(1-choiceLeft),
            sem_choiceRef = sd(1-choiceLeft)/sqrt(n()),
            numTrials = n()) %>%
  ggplot(aes(probFractalDraw, mean_choiceRef))+
  geom_point()+
  geom_errorbar(aes(ymin=mean_choiceRef-sem_choiceRef, ymax=mean_choiceRef+sem_choiceRef), width=.2)+
  geom_hline(aes(yintercept = .5), color="gray")+
  theme(legend.position="none")
```

```{r}
clean_beh_data %>%
  filter(lotteriesSame == 1 & probFractalDraw != "0.5" ) %>%
  mutate(lotteryMoreRelevant = as.numeric(as.character(probFractalDraw))<.6) %>%
  group_by(lotteryMoreRelevant) %>%
  summarise(.groups = "keep",
            mean_choiceRef = mean(1-choiceLeft),
            sem_choiceRef = sd(1-choiceLeft)/sqrt(n()),
            numTrials = n()) %>%
  ggplot(aes(lotteryMoreRelevant, mean_choiceRef))+
  geom_point()+
  geom_errorbar(aes(ymin=mean_choiceRef-sem_choiceRef, ymax=mean_choiceRef+sem_choiceRef), width=.2)+
  geom_hline(aes(yintercept = .5), color="gray")+
  theme(legend.position="none")
```

Risk aversion for fractals

what counts as risky when choice is based on fractals?

```{r}
clean_beh_data %>%
  group_by(subnum, session) %>%
  mutate(numLeftFractalRewarded = cumsum(leftFractalReward),
         numRightFractalRewarded = cumsum(rightFractalReward),
         choseMoreRewardedFractal = ifelse((numLeftFractalRewarded> numRightFractalRewarded) & (choiceLeft==1), TRUE, ifelse((numRightFractalRewarded>numLeftFractalRewarded) & (choiceLeft==0), TRUE, FALSE))) %>%
  group_by(probFractalDraw) %>%
  summarise(mean_choseMoreRewardedFractal = mean(choseMoreRewardedFractal), 
            sem_choseMoreRewardedFractal = sd(choseMoreRewardedFractal)/sqrt(n()))%>%
  ggplot(aes(probFractalDraw, mean_choseMoreRewardedFractal))+
  geom_point()+
  geom_errorbar(aes(ymin=mean_choseMoreRewardedFractal-sem_choseMoreRewardedFractal, ymax=mean_choseMoreRewardedFractal+sem_choseMoreRewardedFractal), width=.2)+
  geom_hline(aes(yintercept = .5), color="gray")
```

## Choice patterns to model

- Better performance for trials where the lotteries matter more for the reward.When fractal matters more choice is around chance in conflict trials and above chance but worse than lottery mattering trials for no conflict trials.
- Asymmetric distortion of attribute relevance: Lottery slopes decline linearly but fractal slopes have a more step-like shape.
- When reward depends more on fractals and the previous trial was rewarded based on the fractals then subjects are more likely to choose the side they chose previously.

# Reaction Time

## Attribute relevance

Distribution for each attribute relevance level. There is a difference in choice speed depending on attribute relevance.

```{r}
clean_beh_data %>%
  ggplot(aes(reactionTime))+
  geom_density(aes(fill=probFractalDraw), position = "identity", alpha=.5, color=NA)+
  scale_fill_brewer(palette="PRGn")
```

Decisions are slowest when both attributes are equally relevant. They are also categorically faster when only fractals matter for reward.

```{r}
p = clean_beh_data %>%
  group_by(probFractalDraw) %>%
  summarise(meanLogRt = mean(logRt),
            semLogRt = sd(logRt)/sqrt(n())) %>%
  ggplot(aes(probFractalDraw, meanLogRt))+
  geom_point()+
  geom_errorbar(aes(ymin=meanLogRt - semLogRt, ymax=meanLogRt + semLogRt), width=.2)+
  labs(y="mean log RT", x="p(Fractal)")

ggsave(file=paste0(fig_out_path, 'rt_by_probfractaldraw.jpg'), p, height = 5, width=8, units="in")
p
```

Do we see this pattern for all subjects? Most but not all. Subjects 9 nd 10 look particularly weird.

```{r}
clean_beh_data %>%
  group_by(subnum, probFractalDraw) %>%
  summarise(.groups="keep",
            meanLogRt = mean(logRt),
            semLogRt = sd(logRt)/sqrt(n())) %>%
  ggplot(aes(probFractalDraw, meanLogRt))+
  geom_point()+
  geom_errorbar(aes(ymin=meanLogRt - semLogRt, ymax=meanLogRt + semLogRt), width=.2)+
  facet_wrap(~subnum, scales="free_y")
```

Does RT depend on any other experimental manipulation?  

## True fractal values

Does it depend on the objective fractal values? Not on average but there are individual differences.

```{r}
clean_beh_data %>%
  select(subnum, reactionTime, fractalLeftProb, fractalRightProb, probFractalDraw) %>%
  gather(key, value, -subnum, -reactionTime, -probFractalDraw) %>%
  ggplot(aes(value, reactionTime))+
  geom_line(aes(group=subnum),stat='smooth',formula = 'y~x', method = "lm",se=FALSE, alpha=.1, size=1)+
  geom_smooth(formula = 'y~x', method = "lm")+
  facet_grid(key~probFractalDraw)
```

## EV of varying lottery

Does it depend on the amount or probability of the varying lottery? No. Not for anyone (or any probFractalDraw level; not shown).

```{r}
clean_beh_data %>%
  select(subnum, reactionTime, lotteryValue, lotteryProb) %>%
  gather(key, value, -subnum, -reactionTime) %>%
  ggplot(aes(value, reactionTime))+
  geom_line(aes(group=subnum),stat='smooth',formula = 'y~x', method = "lm",se=FALSE, alpha=.1, size=1)+
  geom_smooth(formula = 'y~x', method = "lm")+
  facet_wrap(~key, scales="free_x")
```

## Conflict trials

Does it depend on whether the objective values for each attribute agree or disagree on which is the better bundle? No.

```{r}
clean_beh_data %>%
  group_by(probFractalDraw, conflictTrial) %>%
  summarise(.groups="keep",
            meanLogRt = mean(logRt),
            semLogRt = sd(logRt)/sqrt(n())) %>%
  ggplot(aes(probFractalDraw, meanLogRt, color=conflictTrial))+
  geom_point()+
  geom_errorbar(aes(ymin=meanLogRt - semLogRt, ymax=meanLogRt + semLogRt), width=.2)+
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

## Value difference

Choice is faster for larger differences between the lotteries *when* lotteries are more relevant for reward. Otherwise the effect disappears.

```{r}
p = clean_beh_data %>%
  group_by(probFractalDraw, lottery_ev_diff) %>%
  summarise(.groups = "keep",
            mean_logRt = mean(logRt),
            sem_logRt = sd(logRt)/sqrt(n())) %>%
  ggplot(aes(probFractalDraw, mean_logRt,color=lottery_ev_diff))+
  geom_point(position=position_dodge(width=.5))+
  geom_errorbar(aes(ymin = mean_logRt - sem_logRt, ymax = mean_logRt + sem_logRt), width=.2,position=position_dodge(width=.5))+
  theme(legend.position = "bottom")+
  labs(color="Lottery EV difference", y="Mean Log RT", x="p(Fractal)")+
  scale_color_manual(values = c(cbbPalette[3], cbbPalette[5:6]))

ggsave(file=paste0(fig_out_path, 'rt_by_lottery_ev_diff.jpg'), p, height = 5, width=8, units="in")
p
```

Larger fractal value differences *does not* translate to faster choice. There are large individual differences but the average effects are either 0 or in the opposite direction.

Why not?  
Because subjects are not aware/have not learned the value difference?
Because information about the fractals has been processed before the stimulus presentation so the whatever effect fractal value difference might have had is dissipated when we begin measuring RT and the only stimulus processing that happens from that point on is about the lotteries and integration of bundle values?

```{r}
clean_beh_data %>%
  ggplot(aes(fractal_diff, logRt)) + 
  geom_line(aes(group=subnum),stat='smooth',formula = 'y~x', method = "lm",se=FALSE, alpha=.1, size=1)+
  geom_smooth(formula = 'y~x', method = "lm")+
  facet_grid(.~probFractalDraw)
```

On average there is no effect of the relative value differences on RT.

```{r}
p = clean_beh_data %>%
  ggplot(aes(fractal_diff, logRt)) + 
  geom_line(aes(group=subnum),stat='smooth',formula = 'y~x', method = "lm",se=FALSE, alpha=.1, size=1)+
  geom_smooth(formula = 'y~x', method = "lm")+
  facet_grid(lottery_ev_diff~probFractalDraw)+
  labs(x="Difference between fractal probabilities", y = "log RT")+
  scale_x_continuous(breaks=c())

ggsave(file=paste0(fig_out_path, 'rt_by_fractal_prob_diff.jpg'), p, height = 5, width=8, units="in")
p
```

## Learning

Does it depend on trial number/learning how to do the task? Yes. Subjects get faster in later runs on average. In the first run they also get faster with each trial.

```{r}
p = clean_beh_data %>%
  mutate(session = paste0("run ", session)) %>%
  ggplot(aes(trialNum, logRt))+
  geom_line(aes(group=subnum),stat='smooth',formula = 'y~x', method = "lm",se=FALSE, alpha=.1, size=1)+
  geom_smooth(formula = 'y~x', method = "lm")+
  facet_grid(.~session)+
  labs(x = "Trial Number", y = "log RT")
  
  
ggsave(file=paste0(fig_out_path, 'rt_by_session.jpg'), p, height = 5, width=8, units="in")
p
```

## Choice side

Are they faster when they choose left vs right? Since the learned attribute options are both fractals the stimulus difference lies in the lotteries. The bundle on the **right** has the fixed and the one on the right has the varying lottery. So left choices might be slower since they require more processing.

This doesn't seem to be the case overall.

```{r}
clean_beh_data %>%
  group_by(choiceLeft, probFractalDraw) %>%
  summarise(.groups="keep",
            mean_logRt = mean(logRt),
            sem_logRt = sd(logRt)/sqrt(n())) %>%
  mutate(choiceLeft = ifelse(choiceLeft == 0, "right (varying Lottery)", "left (reference Lottery)")) %>%
  ggplot(aes(probFractalDraw, mean_logRt, color=choiceLeft))+
  geom_point()+
  geom_errorbar(aes(ymin = mean_logRt - sem_logRt, ymax = mean_logRt + sem_logRt), width=.2)+
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

There isn't a difference between the lack of this effect depending on whether there is a conflict between the attributes.

```{r}
clean_beh_data %>%
  group_by(choiceLeft, probFractalDraw, conflictTrial) %>%
  summarise(.groups="keep",
            mean_logRt = mean(logRt),
            sem_logRt = sd(logRt)/sqrt(n())) %>%
  mutate(choiceLeft = ifelse(choiceLeft == 0, "right (varying Lottery)", "left (reference Lottery)")) %>%
  ggplot(aes(probFractalDraw, mean_logRt, color=choiceLeft))+
  geom_point()+
  geom_errorbar(aes(ymin = mean_logRt - sem_logRt, ymax = mean_logRt + sem_logRt), width=.2)+
  theme(legend.position = "bottom",
        legend.title = element_blank())+
  facet_grid(conflictTrial~.)


```

## Choice based on lottery

When the lotteries don't have the same EV (80% of the trials) are subjects faster when they choose the bundle with the better lottery? Yes, when the lottery matters more for the reward. This suggests less/no integration of additional attribute (fractals) when correctly choosing based on the relevant attribute. Trials where the lotteries mattered more for the reward but the better lottery bundle was not selected could be considered "errors".

```{r}
p = clean_beh_data %>%
  filter(!lotteriesSame) %>%
  group_by(probFractalDraw, choseBetterLotteryBundle) %>%
  summarise(.groups="keep",
            mean_logRt = mean(logRt),
            sem_logRt = sd(logRt)/sqrt(n())) %>%
  mutate(choseBetterLotteryBundle = ifelse(choseBetterLotteryBundle ==1, "TRUE", "FALSE")) %>%
  ggplot(aes(probFractalDraw, mean_logRt, color=choseBetterLotteryBundle))+
  geom_point()+
  geom_errorbar(aes(ymin = mean_logRt - sem_logRt, ymax = mean_logRt + sem_logRt), width=.2)+
  theme(legend.position = "bottom")+
  labs(x="p(Fractal)", color="Chose Bundle with Better Lottery", y = "mean log RT")+
  scale_color_manual(values = cbbPalette[1:2])

ggsave(file=paste0(fig_out_path, 'rt_by_correct_lottery.jpg'), p, height = 5, width=8, units="in")
p
```
The effect is driven by different types of conflict trials at different levels of probFractalDraw.

```{r}
clean_beh_data %>%
  filter(!lotteriesSame) %>%
  group_by(probFractalDraw, choseBetterLotteryBundle, conflictTrial) %>%
  summarise(.groups="keep",
            mean_logRt = mean(logRt),
            sem_logRt = sd(logRt)/sqrt(n())) %>%
  mutate(choseBetterLotteryBundle = ifelse(choseBetterLotteryBundle ==1, "TRUE", "FALSE")) %>%
  ggplot(aes(probFractalDraw, mean_logRt, color=choseBetterLotteryBundle))+
  geom_point()+
  geom_errorbar(aes(ymin = mean_logRt - sem_logRt, ymax = mean_logRt + sem_logRt), width=.2)+
  theme(legend.position = "bottom")+
  labs(x="p(Fractal)", color="Chose Bundle with Better Lottery", y = "mean log RT")+
  scale_color_manual(values = cbbPalette[1:2])+
  facet_grid(conflictTrial~.)
```

## Choice based on fractal

Are they faster when they choose the bundle with the better fractal? No systematic difference.  

```{r}
p = clean_beh_data %>%
  group_by(probFractalDraw, choseBetterFractalBundle) %>%
  summarise(.groups="keep",
            mean_logRt = mean(logRt),
            sem_logRt = sd(logRt)/sqrt(n())) %>%
  mutate(choseBetterFractalBundle = ifelse(choseBetterFractalBundle ==1, "TRUE", "FALSE")) %>%
  ggplot(aes(probFractalDraw, mean_logRt, color=choseBetterFractalBundle))+
  geom_point()+
  geom_errorbar(aes(ymin = mean_logRt - sem_logRt, ymax = mean_logRt + sem_logRt), width=.2)+
  theme(legend.position = "bottom")+
  labs(x="p(Fractal)", color="Chose Bundle with Better Fractal", y = "mean log RT")+
  scale_color_manual(values = cbbPalette[2:1])

ggsave(file=paste0(fig_out_path, 'rt_by_correct_fractal.jpg'), p, height = 5, width=8, units="in")
p
```

## RT patterns to model  

**Attribute relevance effects**   
- The more similar each attribute is in its relevance for reward the slower the choice.  
- When only the fractals matter choice is categorically faster.  

**Value difference effects**
- Choice is faster for larger EV difference when lotteries matter more for reward.   
- RT does NOT depend on fractal value difference, implying that when modeling RT this might not have to be taken into account.  

**Task learning effect**
- Subjects are on average faster the more trials they have done especially going from the first to the second run.  

**Choice effects**
- Subjects are slightly faster when they choose the bundle with the better lottery when the lottery matters more for the reward. This suggests less/no integration of additional attribute (fractals) when correctly choosing based on the relevant attribute. Trials where the lotteries mattered more for the reward but the better lottery bundle was not selected can be thought of as errors or choices in which the deliberation process was contaminated by the an irrelevant attribute (*opposite of a speed-accuracy tradeoff*).This effect is driven more by no conflict trials. There is no difference in RT for conflict trials depending on whether the bundle with the better lottery was chosen. Maybe the detection as a conflict draws attention/highlights the relevance of an attribute for a reward.  
- A similar effect does not exist for choosing the bundle with the better fractal when fractals are more relevant for reward. This might support the idea that processing of fractals happens before the stimuli are presented (/before we begin measuring RT).  


- 
