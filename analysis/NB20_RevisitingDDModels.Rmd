---
title: 'Experience vs. description based decision-making project: Revisiting DD models'
output:
  html_document:
    toc: yes
    toc_float: yes
    code_folding: 'hide'
  pdf_document:
    toc: yes
---


```{r include=FALSE}
library(tidyverse)
theme_set(theme_bw())
library(here)
cbbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
helpers_path = here('analysis/helpers/')
source(paste0(helpers_path,'01_clean_behavioral_data.R'))
```

```{r message=FALSE}
source(paste0(helpers_path, 'get_qvals.R'))

source(paste0(helpers_path, 'rlModels/fit_rl_hierarchical_oneParamDoubleSymmLinearProbDistortion_rpeBoth.R'))

clean_beh_data = par_ests %>%
  group_by(subnum, par) %>%
  summarise(est = mean(value), .groups='keep') %>%
  spread(par, est) %>%
  left_join(clean_beh_data, by='subnum')

## Add Q values of fractals to each trial
clean_beh_data = clean_beh_data %>%
  group_by(subnum) %>%
  do(get_qvals(., model_name="original")) %>%
  ungroup()

clean_beh_data = clean_beh_data %>%
  mutate(rightLotteryEV = referenceProb * referenceValue,
         leftLotteryEV = lotteryValue * lotteryProb,
         lottery_ev_diff = leftLotteryEV - rightLotteryEV,
         fractal_qv_diff = leftQValue - rightQValue,
         distorted_ev_diff = (1-theta)*(1-probFractalDraw)*lottery_ev_diff,
         distorted_qv_diff = theta*probFractalDraw*fractal_qv_diff,
         abs_distorted_side_value = abs(distorted_ev_diff+distorted_qv_diff),
         abs_distorted_side_value_bins = cut(abs_distorted_side_value, breaks=seq(-1e-10,.38,.03)),
         logRt = log(reactionTime))
```

When both attributes point to the same option choices are faster in true data (plot below).

**Potential problem** for 3 integrator model: The model would predict slower decisions because the difference in the absolute value of each attribute integrator RDV would be small.

```{r}
clean_beh_data %>%
  group_by(abs_distorted_side_value_bins) %>%
  summarise(meanRt = mean(reactionTime),
            semRt = sd(reactionTime)/sqrt(n()), .groups="keep") %>%
  ggplot(aes(abs_distorted_side_value_bins, meanRt))+
  geom_point()+
  geom_errorbar(aes(ymin=meanRt-semRt,ymax=meanRt+semRt), width=.2)+
  xlab("Distorted Absolute evidence ")+
  theme(axis.text.x = element_text(angle=45)) 
```
Note there is very little data in the last three bins of the plot above.

```{r}
round(table(clean_beh_data$abs_distorted_side_value_bins)/nrow(clean_beh_data), 3)
```

Simulate data with a 3 integrator model and see uf this holds.

```{r message=FALSE}
source(paste0(helpers_path,'ddModels/sim_task.R')) # do this first not to mess with cluster setup?
source(paste0(helpers_path,'optimPostProcess/sim_sanity_checks.R'))

set.seed(38573)
```

Select half the data to use as input stimuli for simulated data.

```{r}
sub_data = clean_beh_data %>%
  filter(subnum  %in% c("01", "03", "05","07", "09", "11", "13", "15", "17", "19")) %>%
  select(leftLotteryEV, rightLotteryEV, leftQValue, rightQValue, probFractalDraw, reactionTime, choiceLeft, subnum, distorted_ev_diff, distorted_qv_diff) %>%
  rename(EVLeft = leftLotteryEV, EVRight = rightLotteryEV, QVLeft = leftQValue, QVRight = rightQValue, distortedEVDiff = distorted_ev_diff, distortedQVDiff = distorted_qv_diff)
```

Create empty list that will store the trial simulators for the forthcoming models.

```{r}
sim_trial_list = list()
```

Source trial simulating and fitting function three integrator model. The model only had the ddm parameters as variables; choice parameters (learning rate and probability distortion) are fitted elsewhere and used to compute the distorted value differences fed into this model.

```{r}
source(paste0(helpers_path, 'ddModels/r_ddm_models/ddm_model4b_separatedProbDistortion.R'))
sim_trial_list[['model4b']] = sim_trial
```

Test if trial simulating function works.

```{r}
sim_trial(dLott=0.03, dFrac=0.04, dArb=0.04, sigmaLott = 0.03, sigmaFrac = 0.03, sigmaArb = 0.01, distortedEVDiff = sub_data$distortedEVDiff[100], distortedQVDiff = sub_data$distortedQVDiff[100], probFractalDraw = sub_data$probFractalDraw[100], barrierDecay = 0, EVLeft = sub_data$EVLeft[100], EVRight = sub_data$EVRight[100], QVLeft = sub_data$QVLeft[100], QVRight = sub_data$QVRight[100])
```
Simulate a dataset using half the stimuli and this three integrator model.

```{r}
m4b_1 = sim_task(sub_data, model_name = "model4b", dLott=0.04, dFrac=0.03, dArb=0.06, sigmaLott = 0.03, sigmaFrac = 0.03, sigmaArb = 0.01)
```

Check how well the RT patterns in the simulated data match the true data.

With this parameter setting predicted choice is systematically slower for trials where the fractals matter more. The true data histograms versus predicted density curves also do not look in general.

```{r}
sim_sanity_checks(m4b_1, checks=c(1,3,4))
```

Increasing the fractal drift rate can take care of the slower choice for when fractals are more relevant to a large degree except for the edge case trials where only the fractals matter.

```{r}
m4b_2 = sim_task(sub_data, model_name = "model4b", dLott=0.035, dFrac=0.06, dArb=0.06, sigmaLott = 0.03, sigmaFrac = 0.03, sigmaArb = 0.01)
```

```{r}
sim_sanity_checks(m4b_2, checks=c(1,3,4))
```

What does the relationship between RT and absolute evidence for an option look like in simulated data?

```{r}
tmp = sub_data %>%
  mutate(abs_distorted_side_value = abs(distortedEVDiff+distortedQVDiff),
         abs_distorted_side_value_bins = cut(abs_distorted_side_value, breaks=seq(-1e-10,.38,.03))) %>%
  mutate(data_type="true")


m4b_1 %>%
  mutate(abs_distorted_side_value = abs(distortedEVDiff+distortedQVDiff),
         abs_distorted_side_value_bins = cut(abs_distorted_side_value, breaks=seq(-1e-10,.38,.03))) %>%
  group_by(abs_distorted_side_value_bins) %>%
  summarise(meanRt = mean(reactionTime),
            semRt = sd(reactionTime)/sqrt(n()), .groups="keep") %>%
  mutate(data_type="sim") %>%
  rbind(tmp %>% 
          group_by(abs_distorted_side_value_bins) %>%
          summarise(meanRt = mean(reactionTime),
                    semRt = sd(reactionTime)/sqrt(n())) %>%
           mutate(data_type="true")) %>%
  ggplot(aes(abs_distorted_side_value_bins, meanRt, col=data_type))+
  geom_point()+
  geom_errorbar(aes(ymin=meanRt-semRt,ymax=meanRt+semRt), width=.2)+
  xlab("Absolute evidence ")+
  theme(axis.text.x = element_text(angle=45),
        legend.position = "bottom")
```
How could the negative relationship between RT and absolute evidence for an option be more pronounced for a three integrator model?

Start with looking at how the integrators move for the most extreme trials

```{r}
sample_stim = tmp %>% 
  filter(abs_distorted_side_value_bins == "(0.03,0.06]") %>%
  arrange(reactionTime)

for(i in 1:5){
  
  out = sim_trial(dLott=0.03, dFrac=0.06, dArb=0.06, sigmaLott = 0.03, sigmaFrac = 0.03, sigmaArb = 0.01, distortedEVDiff = sample_stim$distortedEVDiff[i], distortedQVDiff = sample_stim$distortedQVDiff[i], probFractalDraw = sample_stim$probFractalDraw[i], barrierDecay = 0, EVLeft = sample_stim$EVLeft[i], EVRight = sample_stim$EVRight[i], QVLeft = sample_stim$QVLeft[i], QVRight = sample_stim$QVRight[i], debug=TRUE)
  
  if (i == 1){
    pred_df = out$out
  } else{
    pred_df = rbind(pred_df, out$out)
  }
  
  debug_df = out$debug_df
  
  p = debug_df %>%
    select(time, arbitratorRDV, lotteryRDV, fractalRDV) %>%
    gather(key, value, -time) %>%
    ggplot(aes(time, value, color=key))+
    geom_line()+
    geom_hline(aes(yintercept=0), linetype="dashed") +
    theme(legend.position = "bottom")
  
  print(p)
  
}


```

```{r}
head(sample_stim)
```

Are the predicted response times close to the true response times? No! Despite the apparent correspondance when looking at aggregate data grouped by probFractalDraw level the individual trial estimates are not correlated at all.

```{r}
m4b_2 %>%
  mutate(abs_distorted_side_value = abs(distortedEVDiff+distortedQVDiff),
         abs_distorted_side_value_bins = cut(abs_distorted_side_value, breaks=seq(-1e-10,.38,.03))) %>%
  left_join(tmp, by=c("EVLeft", "EVRight", "QVLeft", "QVRight", "distortedEVDiff", "distortedQVDiff", "probFractalDraw")) %>%
  ggplot(aes(reactionTime.y, reactionTime.x))+
    geom_point(color="light gray")+
  geom_smooth(formula="y~x", method="lm")+
  geom_abline(aes(slope=1, intercept=0), linetype="dashed")+
  xlab("True RT")+
  ylab("Predicted RT")
```

Does a well-established model do better in such an absolute check of model fit????

```{r}

```


```{r}
sim_trial(dLott=0.03, dFrac=0.04, dArb=0.04, sigmaLott = 0.03, sigmaFrac = 0.03, sigmaArb = 0.01, distortedEVDiff = sub_data$distortedEVDiff[100], distortedQVDiff = sub_data$distortedQVDiff[100], probFractalDraw = sub_data$probFractalDraw[100], barrierDecay = 0, EVLeft = sub_data$EVLeft[100], EVRight = sub_data$EVRight[100], QVLeft = sub_data$QVLeft[100], QVRight = sub_data$QVRight[100])
```

Check the fitting function

```{r}

```
