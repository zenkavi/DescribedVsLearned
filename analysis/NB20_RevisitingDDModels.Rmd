---
title: 'Experience vs. description based decision-making project: Revisiting DD models'
output:
  html_document:
    toc: yes
    toc_float: yes
    code_folding: 'hide'
  pdf_document:
    toc: yes
---


```{r include=FALSE}
library(tidyverse)
theme_set(theme_bw())
library(here)
cbbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
helpers_path = here('analysis/helpers/')
source(paste0(helpers_path,'01_clean_behavioral_data.R'))
```

```{r message=FALSE}
source(paste0(helpers_path, 'get_qvals.R'))

source(paste0(helpers_path, 'rlModels/fit_rl_hierarchical_oneParamDoubleSymmLinearProbDistortion_rpeBoth.R'))

clean_beh_data = par_ests %>%
  group_by(subnum, par) %>%
  summarise(est = mean(value), .groups='keep') %>%
  spread(par, est) %>%
  left_join(clean_beh_data, by='subnum')

## Add Q values of fractals to each trial
clean_beh_data = clean_beh_data %>%
  group_by(subnum) %>%
  do(get_qvals(., model_name="original")) %>%
  ungroup()

clean_beh_data = clean_beh_data %>%
  mutate(rightLotteryEV = referenceProb * referenceValue,
         leftLotteryEV = lotteryValue * lotteryProb,
         lottery_ev_diff = leftLotteryEV - rightLotteryEV,
         fractal_qv_diff = leftQValue - rightQValue,
         distorted_ev_diff = (1-theta)*(1-probFractalDraw)*lottery_ev_diff,
         distorted_qv_diff = theta*probFractalDraw*fractal_qv_diff,
         abs_distorted_side_value = abs(distorted_ev_diff+distorted_qv_diff),
         abs_distorted_side_value_bins = cut(abs_distorted_side_value, breaks=seq(-1e-10,.38,.03)),
         logRt = log(reactionTime))
```

Problem for 3 integrator model: When both attributes point to the same option choices are faster in true data.

But the model would predict slower decisions because the difference in the absolute value of each attribute integrator RDV would be small.

```{r}
clean_beh_data %>%
  group_by(abs_distorted_side_value_bins) %>%
  summarise(meanRt = mean(reactionTime),
            semRt = sd(reactionTime)/sqrt(n()), .groups="keep") %>%
  ggplot(aes(abs_distorted_side_value_bins, meanRt))+
  geom_point()+
  geom_errorbar(aes(ymin=meanRt-semRt,ymax=meanRt+semRt), width=.2)+
  xlab("Absolute evidence ")+
  theme(axis.text.x = element_text(angle=45)) 
```
Simulate data with a 3 integrator model and show this doesn't hold.

```{r message=FALSE}
source(paste0(helpers_path,'ddModels/sim_task.R')) # do this first not to mess with cluster setup?
source(paste0(helpers_path,'optimPostProcess/sim_sanity_checks.R'))

set.seed(38573)
```


```{r}
sub_data = clean_beh_data %>%
  filter(subnum  %in% c("01", "03", "05","07", "09", "11", "13", "15", "17", "19")) %>%
  select(leftLotteryEV, rightLotteryEV, leftQValue, rightQValue, probFractalDraw, reactionTime, choiceLeft, subnum, distorted_ev_diff, distorted_qv_diff) %>%
  rename(EVLeft = leftLotteryEV, EVRight = rightLotteryEV, QVLeft = leftQValue, QVRight = rightQValue, distortedEVDiff = distorted_ev_diff, distortedQVDiff = distorted_qv_diff)
```

Create empty list that will store the trial simulators for the forthcoming models.

```{r}
sim_trial_list = list()
```

```{r}
source(paste0(helpers_path, 'ddModels/r_ddm_models/ddm_model4b_separatedProbDistortion.R'))
sim_trial_list[['model4b']] = sim_trial
```

```{r}
sim_trial(dLott=0.03, dFrac=0.04, dArb=0.04, sigmaLott = 0.03, sigmaFrac = 0.03, sigmaArb = 0.01, distortedEVDiff = sub_data$distortedEVDiff[100], distortedQVDiff = sub_data$distortedQVDiff[100], probFractalDraw = sub_data$probFractalDraw[100], barrierDecay = 0, EVLeft = sub_data$EVLeft[100], EVRight = sub_data$EVRight[100], QVLeft = sub_data$QVLeft[100], QVRight = sub_data$QVRight[100])
```

## Check sim task

```{r}
m4b_1 = sim_task(sub_data, model_name = "model4b", dLott=0.04, dFrac=0.03, dArb=0.06, sigmaLott = 0.03, sigmaFrac = 0.03, sigmaArb = 0.01)
```

```{r}
sim_sanity_checks(m4b_1, checks=c(1,3,4))
```

```{r}
sub_data %>%
  select(distortedEVDiff, distortedQVDiff) %>%
  gather(key, value) %>%
  ggplot(aes(value, fill=key))+
  geom_histogram(bins=30, alpha=.5, position = "identity")
```


```{r}
m4b_2 = sim_task(sub_data, model_name = "model4b", dLott=0.04, dFrac=0.06, dArb=0.06, sigmaLott = 0.03, sigmaFrac = 0.03, sigmaArb = 0.01)
```

```{r}
sim_sanity_checks(m4b_2, checks=c(1,3,4))
```

```{r}
m4b_1 %>%
  mutate(abs_distorted_side_value = abs(distortedEVDiff+distortedQVDiff),
         abs_distorted_side_value_bins = cut(abs_distorted_side_value, breaks=seq(-1e-10,.38,.03))) %>%
  group_by(abs_distorted_side_value_bins) %>%
  summarise(meanRt = mean(reactionTime),
            semRt = sd(reactionTime)/sqrt(n()), .groups="keep") %>%
  mutate(data_type="sim") %>%
  rbind(sub_data %>%
          mutate(abs_distorted_side_value = abs(distortedEVDiff+distortedQVDiff),
                 abs_distorted_side_value_bins = cut(abs_distorted_side_value, breaks=seq(-1e-10,.38,.03))) %>%
          group_by(abs_distorted_side_value_bins) %>%
          summarise(meanRt = mean(reactionTime),
                    semRt = sd(reactionTime)/sqrt(n()))%>%
          mutate(data_type="true")) %>%
  ggplot(aes(abs_distorted_side_value_bins, meanRt, col=data_type))+
  geom_point()+
  geom_errorbar(aes(ymin=meanRt-semRt,ymax=meanRt+semRt), width=.2)+
  xlab("Absolute evidence ")+
  theme(axis.text.x = element_text(angle=45),
        legend.position = "bottom")
```

```{r}
sub_data %>%
  mutate(abs_distorted_side_value = abs(distortedEVDiff+distortedQVDiff),
         abs_distorted_side_value_bins = cut(abs_distorted_side_value, breaks=seq(-1e-10,.38,.03))) %>%
  group_by(abs_distorted_side_value_bins) %>%
  summarise(meanRt = mean(reactionTime),
            semRt = sd(reactionTime)/sqrt(n())) %>%
  ggplot(aes(abs_distorted_side_value_bins, meanRt))+
  geom_point()+
  geom_errorbar(aes(ymin=meanRt-semRt,ymax=meanRt+semRt), width=.2)+
  xlab("Absolute evidence ")+
  theme(axis.text.x = element_text(angle=45),
        legend.position = "bottom")
```