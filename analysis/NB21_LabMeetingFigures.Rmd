---
title: 'Experience vs. description based decision-making project: Figures for 7/8 lab meeting'
output:
  html_document:
    toc: yes
    toc_float: yes
    code_folding: 'hide'
  pdf_document:
    toc: yes
---

```{r include=FALSE}
library(tidyverse)
theme_set(theme_bw())
library(here)
cbbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
helpers_path = here('analysis/helpers/')

source(paste0(helpers_path,'01_clean_behavioral_data.R'))
source(paste0(helpers_path, 'get_qvals.R'))
fig_out_path = paste0(here(), '/outputs/fig/')

set.seed(38573)
```

Add distorted value estimates using the hierarchical RL fit.

```{r message=FALSE, warning=FALSE}

source(paste0(helpers_path, 'rlModels/fit_rl_hierarchical_oneParamDoubleSymmLinearProbDistortion_rpeBoth.R'))

clean_beh_data = par_ests %>%
  group_by(subnum, par) %>%
  summarise(est = mean(value), .groups='keep') %>%
  spread(par, est) %>%
  left_join(clean_beh_data, by='subnum')

## Add Q values of fractals to each trial
clean_beh_data = clean_beh_data %>%
  group_by(subnum) %>%
  do(get_qvals(., model_name="original")) %>%
  ungroup()

clean_beh_data = clean_beh_data %>%
  mutate(rightLotteryEV = referenceProb * referenceValue,
         leftLotteryEV = lotteryValue * lotteryProb,
         lottery_ev_diff = leftLotteryEV - rightLotteryEV,
         fractal_qv_diff = leftQValue - rightQValue,
         distorted_ev_diff = (1-theta)*(1-probFractalDraw)*lottery_ev_diff,
         distorted_qv_diff = theta*probFractalDraw*fractal_qv_diff)

rm(fit, g_par_est, par_ests)
```

Logit w EV and fractal value

```{r}

```

Logit w EV, fractal value and QV

```{r}

```

Logit w EV, fractal value, QV and prob distortion correction

```{r}

```

RL model comparison

```{r}

```

RT by probFractalDraw

```{r}
p = clean_beh_data %>%
  drop_na()%>%
  mutate(probFractalDraw = as.factor(probFractalDraw), 
         log_rt = log(reactionTime)) %>%
  group_by(probFractalDraw) %>%
  summarise(mean_log_rt = mean(log_rt),
            sem_log_rt = sd(log_rt)/sqrt(n())) %>%
  ggplot(aes(probFractalDraw, mean_log_rt))+
  geom_point()+
  geom_errorbar(aes(ymin = mean_log_rt - sem_log_rt, ymax = mean_log_rt + sem_log_rt), width=.2)+
  theme(panel.grid = element_blank())+
  labs(x = "p(Fractal)", y = "Mean Log RT")

ggsave(file=paste0(fig_out_path, 'labmeet_rt_by_pFrac.jpg'), p, height = 5, width=8, units="in")
p
```

RT by probfractaldraw split by EV difference level

```{r}
p = clean_beh_data %>%
  rename(QVLeft = leftQValue, QVRight = rightQValue, EVLeft = leftLotteryEV, EVRight = rightLotteryEV)%>%
  mutate(lottery_ev_diff = round(abs(EVLeft - EVRight),3),
         lottery_ev_diff = ifelse(lottery_ev_diff ==0, "no EV diff", ifelse(lottery_ev_diff == .2, "small EV diff", ifelse(lottery_ev_diff == .4, "large EV diff", NA))),
         lottery_ev_diff = factor(lottery_ev_diff, levels=c("no EV diff", "small EV diff", "large EV diff"), labels = c("no", "small", "large")),
         logRt = log(reactionTime),
         probFractalDraw = as.factor(probFractalDraw)) %>%
  group_by(probFractalDraw, lottery_ev_diff) %>%
  summarise(.groups = "keep",
            mean_logRt = mean(logRt),
            sem_logRt = sd(logRt)/sqrt(n())) %>%
  ggplot(aes(probFractalDraw, mean_logRt, color=lottery_ev_diff))+
  geom_point(position=position_dodge(width=.5))+
  geom_errorbar(aes(ymin = mean_logRt - sem_logRt, ymax = mean_logRt + sem_logRt), width=.2,position=position_dodge(width=.5))+
  theme(legend.position = "bottom", panel.grid = element_blank())+
  labs(color="Lottery EV difference", y="Mean Log RT", x="p(Fractal)")+
  scale_color_manual(values = c(cbbPalette[3], cbbPalette[5:6]))

ggsave(file=paste0(fig_out_path, 'labmeet_rt_by_evdiff.jpg'), p, height = 5, width=8, units="in")
p
```

RT by probfractaldraw split by QV difference level

```{r}

p = clean_beh_data %>%
  rename(QVLeft = leftQValue, QVRight = rightQValue, EVLeft = leftLotteryEV, EVRight = rightLotteryEV)%>%
  # group_by(subnum) %>%
  mutate(logRt = log(reactionTime),
         QVDiff = abs(QVLeft - QVRight),
         diff_level = ifelse(QVDiff < quantile(QVDiff, probs=c(.33))[[1]], "small",
                             ifelse(QVDiff > quantile(QVDiff, probs=c(.66))[[1]], "large", "medium")),
         diff_level = factor(diff_level, levels=c("small", "medium", "large")),
         probFractalDraw = as.factor(probFractalDraw)) %>%
  group_by(probFractalDraw, diff_level) %>%
  summarise(.groups = "keep",
            mean_logRt = mean(logRt),
            sem_logRt = sd(logRt)/sqrt(n())) %>%
  ggplot(aes(probFractalDraw, mean_logRt,color=diff_level))+
  geom_point(position=position_dodge(width=.5))+
  geom_errorbar(aes(ymin = mean_logRt - sem_logRt, ymax = mean_logRt + sem_logRt), width=.2,position=position_dodge(width=.5))+
  theme(legend.position = "bottom", panel.grid = element_blank())+
  labs(color="Fractal QV difference", y="Mean Log RT", x="p(Fractal)")+
  scale_color_manual(values = c(cbbPalette[3], cbbPalette[5:6]))

ggsave(file=paste0(fig_out_path, 'labmeet_rt_by_qvdiff.jpg'), p, height = 5, width=8, units="in")
p 
```

RT for errors

```{r}
p = clean_beh_data %>%
  rename(distortedEVDiff = distorted_ev_diff, distortedQVDiff = distorted_qv_diff)%>%
  mutate(choice = ifelse(choiceLeft == 1, "left", "right")) %>%
  mutate(leftLotterySubjBetter = distortedEVDiff > 0,
         leftFractSubjBetter = distortedQVDiff > 0,
         choseBetterSubjLott = ifelse(choice == "left" & leftLotterySubjBetter, "correct", ifelse(choice == "right" & !leftLotterySubjBetter, "correct", "incorrect")),
         choseBetterSubjFrac = ifelse(choice == "left" & leftFractSubjBetter, "correct", ifelse(choice == "right" & !leftFractSubjBetter, "correct", "incorrect")),
         logRt = log(reactionTime),
         fractalMoreRelevant = ifelse(probFractalDraw > .5, "fractal more relevant", "lottery more relevant"),
         fractalMoreRelevant = factor(fractalMoreRelevant, levels=c("lottery more relevant", "fractal more relevant"))) %>%
  select(fractalMoreRelevant, choseBetterSubjLott, choseBetterSubjFrac, logRt) %>%
  gather(key, value, -fractalMoreRelevant, -logRt) %>%
  group_by(fractalMoreRelevant, key, value) %>%
  summarise(.groups="keep",
            meanLogRt = mean(logRt),
            semLogRt = sd(logRt)/sqrt(n())) %>%
  mutate(correctBasedOn = ifelse(key == "choseBetterSubjLott", "Correct based on Lottery", "Correct based on Fractal"),
         correctBasedOn = factor(correctBasedOn, levels = c("Correct based on Lottery", "Correct based on Fractal"))) %>%
  ggplot(aes(fractalMoreRelevant, meanLogRt, color=value))+
  geom_point(position=position_dodge(width=.5))+
  geom_errorbar(aes(ymin=meanLogRt-semLogRt, ymax=meanLogRt+semLogRt),width=.2,position=position_dodge(width=.5))+
  labs(x="", y = "Mean Log RT", color="")+
  theme(legend.position = "bottom", panel.grid = element_blank())+
  scale_color_manual(values = c("blue", "red"))+
  facet_wrap(~correctBasedOn)


ggsave(file=paste0(fig_out_path, 'labmeet_rt_by_errors.jpg'), p, height = 5, width=8, units="in")
p    
```

Demo 1 integrator DDM

```{r}

```

Demo 3 integrator DDM

```{r}

```

Distorted EV vs distorted QV (caveat trials)

```{r}

```

Simulation/fit checks

```{r}

```