---
title: "Experience vs. description based decision-making project: Behavioral manipulation checks"
output: 
  html_document:
    toc: true
    toc_float: true
---

# Set up environment and load in data

```{r}
library(tidyverse)
library(gridExtra)
library(brms)
library(here)
```

```{r}
helpers_path = here('helpers/')
```

Read in clean data with Q-learning parameter estimates

```{r}
source(paste0(helpers_path,'fit_qlearning.R'))
```

Set theme for plots

```{r}
theme_set(theme_bw())
```

# Manipulation checks

## Correct interpretation of p(Fractal)$

- When p of fractal is 0 do subjects choose based on the EV difference between lotteries? Does the QV difference matter at all?

- When p of fractal is 1 do subjects choose based on the QV difference between fractals? Does the EV difference matter at all?

```{r}
tmp = clean_beh_data %>%
  filter(probFractalDraw == 1 | probFractalDraw == 0) %>%
  mutate(leftQVAdv = leftQValue - rightQValue,
         leftLotteryEV = lotteryValue*lotteryProb,
         rightLotteryEV = referenceValue*referenceProb,
         leftEVAdv = leftLotteryEV - rightLotteryEV)

tmp %>%
  select(leftQVAdv, leftEVAdv, choiceLeft, probFractalDraw) %>%
  gather(key, value, -choiceLeft, -probFractalDraw) %>%  
  mutate(key = ifelse(key == "leftEVAdv", "EV_left - EV_right", "QV_left - QV_right"),
         probFractalDraw = ifelse(probFractalDraw == 0, "p(Fractal)=0", "p(Fractal)=1")) %>%
  ggplot(aes(value, choiceLeft))+
  geom_jitter(width=0.03, height=0.08, alpha = 0.05)+
  geom_smooth(formula = 'y~x', method = "glm", method.args = list(family=binomial), fullrange=TRUE)+
  facet_grid(probFractalDraw~key)+
  xlab("")+
  ylab("p(Left)")
```

Multilevel model checking if the slopes of the top row above are different than 0.

```{r}
m1 = brm(choiceLeft ~ leftQVAdv + leftEVAdv + (1|subnum),
        data=tmp %>% filter(probFractalDraw == 0), family=bernoulli(link="logit"))
```

When probability of a fractal is 0 the expected value (EV) difference between the lotteries (i.e. the only relevant attribute of each bundle) has a strong effect. The higher the EV of the left lottery the more likely the left bundle is chosen. 

There is also a much smaller negative effect of the Q-value difference even though the fractal values should be irrelevant. 

```{r}
summary(m1)
```

Multilevel model checking if the slopes of the bottom row above are different than 0.

```{r}
m2 = brm(choiceLeft ~ leftQVAdv + leftEVAdv + (1|subnum),
        data=tmp %>% filter(probFractalDraw == 1), family=bernoulli(link="logit"))
```

When the probability of the fractal draw is 1 so the reward only depends on the fractals only the learned Q-values for the fractals have an effect on choice (the lotter EV difference has no effect).

Note: these Q-values are from model fits where choice is only modeled as a function of the fractal values. Joint modeling of all relevant attributes in each bundle is done in the next notebook.

```{r}
summary(m2)
```


```{r}
rm(tmp, m1, m2)
```

## Lottery bias in conflict trials

When the better lottery and the better fractal (based on the learned Q value) suggest different options do subjects choose more frequently based on the lottery or their fractal Q Value? Yes, there is a general tendency towards choosing the option with the better lottery even when the trial reward depends less on the lottery and more on the fractal (p(Fractal) >=.5). Only when the outcome depend entirely on the fractal are people more likely to choose the option with the better fractal but even then there is a non-negligible portion of choices determined by the lottery EV. 

```{r}
tmp = clean_beh_data %>%
  mutate(leftLotteryEV = lotteryValue*lotteryProb,
  			 rightLotteryEV = referenceValue*referenceProb,
  			 leftLotteryBetter = leftLotteryEV>rightLotteryEV,
         choseBetterLottery = ifelse(leftLotteryBetter & choiceLeft == 1, 1, 
                                     ifelse(!leftLotteryBetter & choiceLeft == 0, 1, 0)),
         leftFractalBetter = leftQValue>rightQValue,
         choseBetterFractal = ifelse(leftFractalBetter & choiceLeft == 1, 1, 
                                     ifelse(!leftFractalBetter & choiceLeft == 0, 1, 0))) %>%
  filter(leftFractalBetter != leftLotteryBetter) #filter conflict trials

tmp %>% 
  group_by(probFractalDraw, subnum) %>%
  summarise(choseBetterLottery = mean(choseBetterLottery),
            choseBetterFractal = mean(choseBetterFractal),
            .groups='keep') %>%
  gather(key, value, -probFractalDraw, -subnum) %>%
  mutate(key = ifelse(key == "choseBetterFractal", "Chose Better Fractal", "Chose Better Lottery")) %>%
  ggplot(aes(as.factor(probFractalDraw), value, color=key))+
  geom_boxplot()+
 labs(x="p(Fractal)",y="Proportion of choices",color="", 
      title="Lottery bias in conflict trials (EV and QV difference suggest opposite choices)")+
  scale_color_manual(values=cbbPalette)+
  theme(legend.position = "bottom")

```

Re-plot this as proportion of choice using the relevant attribute

```{r}
tmp %>%
  filter(probFractalDraw != .5) %>% #filter trials where relevant attribute is clear
  mutate(fractalRelevant = ifelse(probFractalDraw <.5, 0, 1),
         choseRelevant = ifelse(fractalRelevant & choseBetterFractal, 1,
                                ifelse(fractalRelevant == 0 & choseBetterLottery, 1, 0))) %>%
  group_by(probFractalDraw, subnum) %>%
  summarise(choseRelevant = mean(choseRelevant),
            .groups = 'keep') %>%
  ggplot(aes(as.factor(probFractalDraw), choseRelevant))+
  geom_hline(yintercept = .5, linetype="dashed", color= cbbPalette[2], size = 1.5)+
  geom_boxplot()+
  labs(y = "Proportion of choices based on relevant attribute",
       x = "p(Fractal)",
       title = "Lottery bias in conflict trials with unambiguous relevant option")+
  annotate("text", x = 3, y = .25, label = "Lottery relevant")+
  annotate("segment", x = 1, xend = 5, y = .28, yend = .28, colour = cbbPalette[1])+
  annotate("segment", x = 1, xend = 1, y = .28, yend = .33, colour = cbbPalette[1])+
  annotate("segment", x = 5, xend = 5, y = .28, yend = .33, colour = cbbPalette[1])+
  annotate("text", x = 8, y = .86, label = "Fractal relevant")+
  annotate("segment", x = 6, xend = 10, y = .83, yend = .83, colour = cbbPalette[1])+
  annotate("segment", x = 6, xend = 6, y = .78, yend = .83, colour = cbbPalette[1])+
  annotate("segment", x = 10, xend = 10, y = .78, yend = .83, colour = cbbPalette[1])
  
```

**ADD statistical test to check if the proportion of lottery based choices are higher than 50% for all levels of $\pi$**

What do I want to check for to show the lottery bias?

Why don't people chose using the relevant attribute all the time?

- Do they not learn the fractal values well?
- Do they distort the probability of fractal and think it is less likely to get a reward from a fractal?
