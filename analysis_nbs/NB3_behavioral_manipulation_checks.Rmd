---
title: "Experience vs. description based decision-making project: Behavioral manipulation checks"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: 'hide'
---

# Set up environment and load in data

```{r include=FALSE}
library(tidyverse)
library(gridExtra)
library(brms)
library(here)
cbbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

```{r}
helpers_path = here('helpers/')
```

Read in clean data with Q-learning parameter estimates

```{r}
source(paste0(helpers_path,'fit_twoValSystemsWithRL_hierarchical.R'))
```

Set theme for plots

```{r}
theme_set(theme_bw())
```

# Manipulation checks

## Correct interpretation of p(Fractal)$

- When p of fractal is 0 do subjects choose based on the EV difference between lotteries? Does the QV difference matter at all?

- When p of fractal is 1 do subjects choose based on the QV difference between fractals? Does the EV difference matter at all?

```{r}
## Save posteroior mean estimates to `clean_beh_data`
clean_beh_data = par_ests %>%
  group_by(subnum, par) %>%
  summarise(est = mean(value), .groups='keep') %>%
  spread(par, est) %>%
  left_join(clean_beh_data, by='subnum')

## Add Q values to each trial
clean_beh_data = clean_beh_data %>%
  group_by(subnum) %>%
  do(get_qvals(.)) %>%
  ungroup()
```

```{r}
tmp = clean_beh_data %>%
  filter(probFractalDraw == 1 | probFractalDraw == 0) %>%
  mutate(leftQVAdv = leftQValue - rightQValue,
         leftLotteryEV = lotteryValue*lotteryProb,
         rightLotteryEV = referenceValue*referenceProb,
         leftEVAdv = leftLotteryEV - rightLotteryEV)

tmp %>%
  select(leftQVAdv, leftEVAdv, choiceLeft, probFractalDraw) %>%
  gather(key, value, -choiceLeft, -probFractalDraw) %>%  
  mutate(key = ifelse(key == "leftEVAdv", "EV_left - EV_right", "QV_left - QV_right"),
         probFractalDraw = ifelse(probFractalDraw == 0, "p(Fractal)=0", "p(Fractal)=1")) %>%
  ggplot(aes(value, choiceLeft))+
  geom_jitter(width=0.03, height=0.08, alpha = 0.05)+
  geom_smooth(formula = 'y~x', method = "glm", method.args = list(family=binomial), fullrange=TRUE)+
  facet_grid(probFractalDraw~key)+
  xlab("")+
  ylab("p(Left)")
```

Multilevel model checking if the slopes of the top row above are different than 0.

```{r eval=FALSE}
m1 = brm(choiceLeft ~ leftQVAdv + leftEVAdv + (1|subnum),
        data=tmp %>% filter(probFractalDraw == 0), family=bernoulli(link="logit"))
```

When probability of a fractal is 0 the expected value (EV) difference between the lotteries (i.e. the only relevant attribute of each bundle) has a strong effect. The higher the EV of the left lottery the more likely the left bundle is chosen. 

There is also a much smaller negative effect of the Q-value difference even though the fractal values should be irrelevant. 

```{r eval=FALSE}
summary(m1)
```

Multilevel model checking if the slopes of the bottom row above are different than 0.

```{r eval=FALSE}
m2 = brm(choiceLeft ~ leftQVAdv + leftEVAdv + (1|subnum),
        data=tmp %>% filter(probFractalDraw == 1), family=bernoulli(link="logit"))
```

When the probability of the fractal draw is 1 so the reward only depends on the fractals only the learned Q-values for the fractals have an effect on choice (the lotter EV difference has no effect).

Note: these Q-values are from model fits where choice is only modeled as a function of the fractal values. Joint modeling of all relevant attributes in each bundle is done in the next notebook.

```{r eval=FALSE}
summary(m2)
```


```{r eval=FALSE}
rm(tmp, m1, m2)
```

## Probability distortion

How do the median estimates suggest the probability of a fractal draw is distorted for each subject?

Using Gonzalez and Wu's (1999) terminology the fact that almost all subjects probability weighting functions are below the 45-degree line (i.e. objective probability) regardless of the inverse-S shape is not about diminishing sensitivy/discriminability (slope) but about **attractiveness** (intercept, elevation). The fractal is almost always less attractive to subjects than it really should be given its probability in determining their reward.

Unlike the simple case where the probability weighting function represents the probability of a reward, however, in this case the probability of a reward is the joint probability of p(Fractal)*p(chosen Fractal's reward)

```{r}
tmp = par_ests %>%
  group_by(subnum, par) %>%
  summarise(est = mean(value), .groups='keep') %>%
  filter(par != "beta" & par != "alpha") %>%
  spread(par, est)

tmp = do.call("rbind", replicate(11, tmp, simplify = FALSE)) %>%
  arrange(subnum) %>%
  ungroup() %>%
  mutate(pFrac = rep(seq(0, 1, .1), 25), 
         wpFrac = (delta*pFrac^gamma)/(delta*pFrac^gamma + (1-pFrac)^gamma)) 

tmp %>%
  mutate(delta_gt_1 = ifelse(delta>=1, "delta >= 1", "delta < 1 "),
         gamma_gt_1 = ifelse(gamma>=1,"gamma >= 1", "gamma < 1")) %>%
  ggplot(aes(pFrac, wpFrac, group=subnum))+
  geom_line(aes(col = as.factor(gamma_gt_1), linetype=as.factor(delta_gt_1)))+
  geom_abline(slope=1, intercept=0, linetype="dashed")+
  labs(x="p(Fractal)", y="w(pFractal)", title="Distortion of p(Fractal)", color = element_blank(), linetype=element_blank())
```

```{r}
rm(tmp)
```

## Lottery bias in conflict trials

When the better lottery and the better fractal (based on the learned Q value) suggest different options do subjects choose more frequently based on the lottery or their fractal Q Value? Yes, there is a general tendency towards choosing the option with the better lottery even when the trial reward depends less on the lottery and more on the fractal (p(Fractal) >=.5). Only when the outcome depend entirely on the fractal are people more likely to choose the option with the better fractal but even then there is a non-negligible portion of choices determined by the lottery EV. 

```{r}
tmp = clean_beh_data %>%
  mutate(leftLotteryEV = lotteryValue*lotteryProb,
  			 rightLotteryEV = referenceValue*referenceProb,
  			 leftLotteryBetter = leftLotteryEV>rightLotteryEV,
         choseBetterLottery = ifelse(leftLotteryBetter & choiceLeft == 1, 1, 
                                     ifelse(!leftLotteryBetter & choiceLeft == 0, 1, 0)),
         leftFractalBetter = leftQValue>rightQValue,
         choseBetterFractal = ifelse(leftFractalBetter & choiceLeft == 1, 1, 
                                     ifelse(!leftFractalBetter & choiceLeft == 0, 1, 0))) %>%
  filter(leftFractalBetter != leftLotteryBetter) #filter conflict trials

tmp %>% 
  group_by(probFractalDraw, subnum) %>%
  summarise(choseBetterLottery = mean(choseBetterLottery),
            choseBetterFractal = mean(choseBetterFractal),
            .groups='keep') %>%
  gather(key, value, -probFractalDraw, -subnum) %>%
  mutate(key = ifelse(key == "choseBetterFractal", "Chose Better Fractal", "Chose Better Lottery")) %>%
  ggplot(aes(as.factor(probFractalDraw), value, color=key))+
  geom_boxplot()+
 labs(x="p(Fractal)",y="Proportion of choices",color="", 
      title="Lottery bias in conflict trials (EV and QV difference suggest opposite choices)")+
  scale_color_manual(values=cbbPalette)+
  theme(legend.position = "bottom")

```

Re-plot this as proportion of choice using the relevant attribute

```{r}
tmp = tmp %>%
  filter(probFractalDraw != .5) %>% #filter trials where relevant attribute is clear
  mutate(fractalRelevant = ifelse(probFractalDraw <.5, 0, 1),
         choseRelevant = ifelse(fractalRelevant & choseBetterFractal, 1,
                                ifelse(fractalRelevant == 0 & choseBetterLottery, 1, 0)))
tmp %>%
  group_by(probFractalDraw, subnum) %>%
  summarise(choseRelevant = mean(choseRelevant),
            .groups = 'keep') %>%
  ggplot(aes(as.factor(probFractalDraw), choseRelevant))+
  geom_hline(yintercept = .5, linetype="dashed", color= cbbPalette[2], size = 1.5)+
  geom_boxplot()+
  labs(y = "Proportion of choices based on relevant attribute",
       x = "p(Fractal)",
       title = "Lottery bias in conflict trials with unambiguous relevant option")+
  annotate("text", x = 3, y = .25, label = "Lottery relevant")+
  annotate("segment", x = 1, xend = 5, y = .28, yend = .28, colour = cbbPalette[1])+
  annotate("segment", x = 1, xend = 1, y = .28, yend = .33, colour = cbbPalette[1])+
  annotate("segment", x = 5, xend = 5, y = .28, yend = .33, colour = cbbPalette[1])+
  annotate("text", x = 8, y = .86, label = "Fractal relevant")+
  annotate("segment", x = 6, xend = 10, y = .83, yend = .83, colour = cbbPalette[1])+
  annotate("segment", x = 6, xend = 6, y = .78, yend = .83, colour = cbbPalette[1])+
  annotate("segment", x = 10, xend = 10, y = .78, yend = .83, colour = cbbPalette[1])
  
```

```{r}
tmp %>%
  group_by(probFractalDraw, subnum, delta, gamma) %>%
  summarise(choseRelevant = mean(choseRelevant),
            .groups = 'keep') %>%
  filter(probFractalDraw != 0 & probFractalDraw != 1) %>%
  mutate(wpFrac = (delta*probFractalDraw^gamma)/(delta*probFractalDraw^gamma + (1-probFractalDraw)^gamma),
         wpFracBin = factor(round(wpFrac, 1), labels = c(seq(0, 1, .1)), levels=c(seq(0, 1, .1)))) %>%
  filter(wpFracBin != .5) %>%
  ggplot(aes(wpFracBin, choseRelevant))+
  geom_boxplot()+
  geom_hline(yintercept = .5, linetype="dashed", color= cbbPalette[2], size = 1.5)+
  labs(y = "Proportion of choices based on relevant attribute",
       x = "Subjective probability [w(p(Fractal))]",
       title="Lottery bias in conflict trials with unambiguous relevant option")
  
```
```{r}
tmp %>%
  group_by(probFractalDraw, subnum, delta, gamma) %>%
  summarise(choseRelevant = mean(choseRelevant),
            .groups = 'keep') %>%
  filter(probFractalDraw != 0 & probFractalDraw != 1) %>%
  mutate(wpFrac = (delta*probFractalDraw^gamma)/(delta*probFractalDraw^gamma + (1-probFractalDraw)^gamma),
         pFracDistortion = wpFrac-probFractalDraw,
         probFractalDraw = as.factor(probFractalDraw)) %>%
  ggplot(aes(pFracDistortion, choseRelevant))+
  geom_point()+
  geom_smooth(method="lm", formula = 'y ~ x', color=cbbPalette[2])+
  facet_wrap(~probFractalDraw)+
  labs(y = "Proportion of choices based on relevant attribute",
       x = "w(p(Fractal)) - p(Fractal)",
       title="Conflict trials with clear relevant attribute")
```

Multilevel model checking if subjects chose based on the relevant attribute regardless of what attribute was relevant.

A choice is less likely to be based on the relevant attribute in conflict trials when the relevant attribute is the fractal. In other words, people rely more the description-based attribute (lotteries) than the experience-based ones (fractals) even when their reward is more likely to depend on the experience-based attribute.

```{r eval=FALSE}
m1 = brm(choseRelevant ~ as.factor(fractalRelevant) + (1|subnum),
        data=tmp, family=bernoulli(link="logit"))
```

When the fractal is the relevant option subjects chose less frequently based on the relevant option.

```{r eval=FALSE}
summary(m1)
```

```{r eval=FALSE}
rm(tmp, m1)
```

Is the over-reliance on the description-based attribute due to distortion of the probability that the reward will depend on the experience-based attribute or the distortion/ bad learning of the experience-based attributes value?

To examine this we compute the proportion of choices that align with the relevant attribute in conflict trials where the experience-based attribute is more relevant. These subject-level estimates are then correlated with parameters from the two valuation systems model. Specifically a non-zero slope between the proportion of choices and delta or gamma would suggest that the bias is due to distorted probability estimates. On the other hand a non-zero slope with learning rates would point towards distorted values.

```{r}
tmp = tmp %>%
  filter(probFractalDraw > 0.5 & probFractalDraw < 1) %>%
  group_by(subnum) %>%
  summarise(meanChoseRelevant = mean(choseRelevant),
            alpha = mean(alpha),
            delta = mean(delta), 
            gamma = mean(gamma),
            .groups = 'keep') 

tmp %>%
  gather(key, value, -subnum, -meanChoseRelevant) %>%
  ggplot(aes(value, meanChoseRelevant)) +
  geom_point()+
  geom_smooth(method="lm", formula = 'y ~ x', color=cbbPalette[2])+
  facet_wrap(~key, scale = "free_x")+
  labs(x="", y="Proportion of choices based on the relevant option",
       title = "Conflict trials where 1>p(Fractal)>.5")+
  geom_hline(yintercept = .5, linetype = "dashed")+
  theme(legend.position = "none")
```

```{r eval=FALSE}
m1 = brm(meanChoseRelevant ~ alpha+delta+gamma,
        data=tmp)
```

We find that only the slope with delta estimates is reliably > 0. Delta primarily controls the intercept of the probability distortion function. Higher values of delta suggests that a subject find choosing based on fractals more "attractive."

```{r eval=FALSE}
summary(m1)
```

```{r eval=FALSE}
rm(tmp, m1)
```
