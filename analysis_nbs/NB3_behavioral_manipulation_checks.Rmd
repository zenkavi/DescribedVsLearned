---
title: "Experience vs. description based decision-making project: Behavioral manipulation checks"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: 'hide'
---

# Set up environment and load in data

```{r include=FALSE}
library(tidyverse)
library(gridExtra)
library(brms)
library(here)
cbbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
theme_set(theme_bw())
```

```{r include=FALSE}
helpers_path = here('helpers/')
source(paste0(helpers_path,'fit_twoValSystemsWithRL_hierarchical.R'))
```

```{r}
## Save posterior mean estimates to `clean_beh_data`
clean_beh_data = par_ests %>%
  group_by(subnum, par) %>%
  summarise(est = mean(value), .groups='keep') %>%
  spread(par, est) %>%
  left_join(clean_beh_data, by='subnum')

## Add Q values of fractals to each trial
clean_beh_data = clean_beh_data %>%
  group_by(subnum) %>%
  do(get_qvals(.)) %>%
  ungroup()

## Add EVs for lotteries to each trial
clean_beh_data = clean_beh_data %>%
  mutate(leftLotteryEV = lotteryValue*lotteryProb,
         rightLotteryEV = referenceValue*referenceProb)

## Add conflict trial info and value difference
clean_beh_data = clean_beh_data %>%
  mutate(leftLotteryBetter = leftLotteryEV>rightLotteryEV,
         choseBetterLottery = ifelse(leftLotteryBetter == 1 & choiceLeft == 1, 1, 
                                     ifelse(leftLotteryBetter == 0 & choiceLeft == 0, 1, 0)),
         leftFractalBetter = leftQValue>rightQValue,
         conflictTrial = ifelse(leftFractalBetter != leftLotteryBetter, "conflict", "no conflict")) %>%
  mutate(leftQVAdv = leftQValue - rightQValue,
         leftEVAdv = leftLotteryEV - rightLotteryEV,
         wpFrac = (delta*probFractalDraw^gamma)/(delta*probFractalDraw^gamma + (1-probFractalDraw)^gamma),
         leftBundleVal = (1-wpFrac)*leftLotteryEV + wpFrac*leftQValue,
         rightBundleVal = (1-wpFrac)*rightLotteryEV + wpFrac*rightQValue,
         leftbundleValAdv = leftBundleVal - rightBundleVal)
```

# Psychometric choice curves

Psychometric curve for all trials with weighted value difference. Q-values for the fractals and the weights for the two attributes are determined by the posterior means of the hierarchically fit two systems model.

```{r}
clean_beh_data %>%
  ggplot(aes(leftbundleValAdv, choiceLeft))+
  geom_line(aes(group=subnum),stat="smooth",formula = 'y~x', method = "glm", method.args = list(family=binomial), fullrange=TRUE, se=FALSE, alpha=.1, size=1, color=cbbPalette[5])+
  geom_smooth(formula = 'y~x', method = "glm", method.args = list(family=binomial), fullrange=TRUE, color=cbbPalette[3], alpha=.75)+
  labs(y = "p(Left)", x = "V(left)-V(right)", title="Psychometric choice curve based on weighted value difference between bundles")
```

Note that this is true for all levels of p(Frac) and conflict trial type

```{r warning=FALSE}
clean_beh_data %>%
  ggplot(aes(leftbundleValAdv, choiceLeft))+
  geom_line(aes(group=subnum),stat="smooth",formula = 'y~x', method = "glm", method.args = list(family=binomial), fullrange=TRUE, se=FALSE, alpha=.1, size=1, color=cbbPalette[5])+
  geom_smooth(formula = 'y~x', method = "glm", method.args = list(family=binomial), fullrange=TRUE, color=cbbPalette[3], alpha=.75)+
  labs(y = "p(Left)", x = "V(left)-V(right)")+
  facet_grid(conflictTrial ~ probFractalDraw)+
  theme(axis.ticks.x=element_blank(),
        axis.text.x=element_blank())
```

## Single relevant attribute trials

What percentage of all trials' rewards depend entirely either on the lottery or the fractals?

```{r}
tmp = clean_beh_data %>%
  filter(probFractalDraw == 1 | probFractalDraw == 0) %>%
  mutate(leftQVAdv = leftQValue - rightQValue,
         leftEVAdv = leftLotteryEV - rightLotteryEV)

round(nrow(tmp)/nrow(clean_beh_data), 3)
```

If subjects have understood the task then in these trials only the value difference of the relevant attribute should have an effect on choice.

- When p of fractal is 0 do subjects choose based on the EV difference between lotteries? Does the QV difference matter at all?

- When p of fractal is 1 do subjects choose based on the QV difference between fractals? Does the EV difference matter at all?

```{r warning=FALSE}
tmp %>%
  select(subnum, leftQVAdv, leftEVAdv, choiceLeft, probFractalDraw) %>%
  gather(key, value, -choiceLeft, -probFractalDraw, -subnum) %>%  
  mutate(key = ifelse(key == "leftEVAdv", "EV_left - EV_right", "QV_left - QV_right"),
         probFractalDraw = ifelse(probFractalDraw == 0, "p(Fractal)=0", "p(Fractal)=1")) %>%
  ggplot(aes(value, choiceLeft))+
  # geom_jitter(width=0.03, height=0.08, alpha = 0.05)+
  geom_line(aes(group=subnum),stat='smooth',formula = 'y~x', method = "glm", method.args = list(family=binomial), fullrange=TRUE, se=FALSE, alpha=.1, size=1, color=cbbPalette[5])+
  geom_smooth(formula = 'y~x', method = "glm", method.args = list(family=binomial), fullrange=TRUE, color=cbbPalette[3])+
  facet_grid(probFractalDraw~key)+
  xlab("")+
  ylab("p(Left)")
```

Multilevel model checking if the slopes of the top row above are different than 0.

```{r eval=FALSE}
m1 = brm(choiceLeft ~ leftQVAdv + leftEVAdv + (1|subnum),
        data=tmp %>% filter(probFractalDraw == 0), family=bernoulli(link="logit"))
```

When probability of a fractal is 0 the expected value (EV) difference between the lotteries (i.e. the only relevant attribute of each bundle) has a strong effect. The higher the EV of the left lottery the more likely the left bundle is chosen. 

There is also a much smaller negative effect of the Q-value difference even though the fractal values should be irrelevant. 

```{r eval=FALSE}
summary(m1)
```

Multilevel model checking if the slopes of the bottom row above are different than 0.

```{r eval=FALSE}
m2 = brm(choiceLeft ~ leftQVAdv + leftEVAdv + (1|subnum),
        data=tmp %>% filter(probFractalDraw == 1), family=bernoulli(link="logit"))
```

When the probability of the fractal draw is 1 so the reward only depends on the fractals only the learned Q-values for the fractals have an effect on choice (the lottery EV difference has no effect).

```{r eval=FALSE}
summary(m2)
```


```{r eval=FALSE}
rm(tmp, m1, m2)
```

# Attribute weights

Since there are two attributes in each bundle the observed and learned values of these attributes can agree or disagree on which bundle is better to choose. Trials where the fractal and lottery value difference favors the same bundle are called *no conflict* trials and trials where they favor different bundles are called *conflict* trials. Subjects can choose to weight each attribute differently in each trial. Whether they weight each attribute appropriately depends on the experimenter-controlled relevance of that attribute for that trial's reward.

What proportion of each type of trial is there? About half of the trials for each subject are conflict trials.

```{r}
round(prop.table(table(clean_beh_data$conflictTrial, clean_beh_data$subnum), margin=2), 2)
```

In conflict trials:  
- when reward depends more on lotteries people correctly choose the bundle with the better lottery above chance.  
- when reward depends equally on both attributes people are  slightly *biased* towards the bundle with the better lottery.  
- when reward depends more on fractals people choose the bundle with the better fractal more frequently *but not as much as they choose the better lottery for the equivalent levels of relevance*  

In no conflict trials:  
- when reward depends more or equally on lotteries people correctly choose the bundle that has both the better fractal and the better lottery.  
- when reward depends more on fractals people *incorrectly* choose the bundle with the better fractal and better lottery less frequently. This suggests that their decision **correctly** depends less on the lottery and more on the fractals but their inference about the fractal values are more noisy and therefore error prone because it involves learning and cannot be read off the screen.  

```{r}
clean_beh_data %>% 
  group_by(probFractalDraw, subnum, conflictTrial) %>%
  summarise(choseBetterLottery = mean(choseBetterLottery),
            .groups='keep') %>%
  ggplot(aes(as.factor(probFractalDraw), choseBetterLottery))+
  geom_boxplot(color=cbbPalette[2])+
  geom_hline(yintercept=0.5, linetype="dashed", size=1.5)+
  facet_grid(conflictTrial~.)+
  labs(x="p(Fractal)",y="Choice of bundle with better lottery")

```

## Psychometric curves by conflict type

```{r}
clean_beh_data %>%
  select(choiceLeft, leftQVAdv, leftEVAdv, probFractalDraw, conflictTrial) %>%
  gather(key, value, -choiceLeft, -probFractalDraw, -conflictTrial) %>%
  mutate(key = ifelse(key == "leftEVAdv", "EV(left)-EV(right)", "QV(left)-QV(right)")) %>%
  ggplot(aes(value, choiceLeft, color=key))+
  geom_smooth(formula = 'y~x', method = "glm", method.args = list(family=binomial), fullrange=TRUE)+
  facet_grid(conflictTrial~probFractalDraw)+
  theme(legend.position = "bottom")+
  xlab("")+
  labs(color="")+
  scale_color_manual(values=c(cbbPalette[2], cbbPalette[1]))
```

Run logits in above graph. Fixed effects analysis allowing for random intercepts.

```{r}
if(file.exists(paste0(helpers_path, 'logitOut_choiceLeft.RDS'))){
  out_choiceLeft = readRDS(paste0(helpers_path, 'logitOut_choiceLeft.RDS'))
} else {
  
  probFractalDrawVals = unique(clean_beh_data$probFractalDraw)
  conflictTrialTypes = unique(clean_beh_data$conflictTrial)
  out_choiceLeft = data.frame(probFractalDraw=NA,conflictTrial=NA,iv=NA,est=NA,u95=NA,l95=NA)
  
  for(i in 1:length(probFractalDrawVals)){
    curProbFractalDraw = probFractalDrawVals[i]
    
    dat = clean_beh_data %>%
      filter(probFractalDraw == curProbFractalDraw)
    
    for(j in 1:length(conflictTrialTypes)){
      
      curConflictTrial = conflictTrialTypes[j]
      
      m = brm(choiceLeft ~ leftQVAdv + leftEVAdv + (1|subnum),
              data=dat %>% filter(conflictTrial==curConflictTrial), family=bernoulli(link="logit"), silent=2, refresh=0)
      
      est = coef(m)$subnum[1,1,2]
      u95 = coef(m)$subnum[1,3,2]
      l95 = coef(m)$subnum[1,4,2]
      
      out_choiceLeft = rbind(out_choiceLeft, c(curProbFractalDraw, curConflictTrial, "leftQVAdv", est, u95, l95))
      
      est = coef(m)$subnum[1,1,3]
      u95 = coef(m)$subnum[1,3,3]
      l95 = coef(m)$subnum[1,4,3]
      
      out_choiceLeft = rbind(out_choiceLeft, c(curProbFractalDraw, curConflictTrial, "leftEVAdv", est, u95, l95))
    }
  }
  
  out_choiceLeft = out_choiceLeft %>%
    drop_na()
  
  saveRDS(out_choiceLeft, paste0(helpers_path, 'logitOut_choiceLeft.RDS'))
  rm(dat, m, conflictTrialTypes, curConflictTrial, probFractalDrawVals, curProbFractalDraw)
}
```

Subjects rely on the relevant attribute and to similar degrees depending on their relevance regardless of conflict trial

What they should do for conflict trials

```{r}
out_choiceLeft %>%
  mutate(est = as.numeric(est),
         l95 = as.numeric(l95),
         u95 = as.numeric(u95)) %>%
  mutate(iv = ifelse(iv == "leftEVAdv", "EV(left)-EV(right)", "QV(left)-QV(right)")) %>%
  ggplot(aes(probFractalDraw, est, col=iv))+
  geom_point()+
  geom_line(aes(group=iv))+
  geom_errorbar(aes(ymin=l95, ymax=u95), width=0.1)+
  geom_hline(yintercept=0,linetype="dashed")+
  facet_grid(conflictTrial ~ .)+
  theme(legend.position = "bottom")+
  scale_color_manual(values=c(cbbPalette[2], cbbPalette[1]))+
  labs(color="", y="Logit slope estimate (DV = choiceLeft)", x="p(Frac)")
```

## Probability distortion

$$V_i = (1-w(pFrac))EV_i + w(pFrac)QV_i, \:i \in \{left, right\}$$

$$w(pFrac) = \frac{\delta*pFrac^{\gamma}}{\delta*pFrac^{\gamma}+(1- pFrac)^{\gamma}}$$

How do the mean posterior estimates suggest the probability of a fractal draw is distorted for each subject?

Using Gonzalez and Wu's (1999) terminology the fact that for most subjects the probability weighting functions are below the 45-degree line (i.e. objective probability, i.e. $\delta < 1$) regardless of shape is not about diminishing sensitivity (slope) but about **attractiveness** (intercept, elevation). The fractal is almost always less attractive to subjects than it should be given its probability in determining their reward.

Note that for many subject the probability weighting function does not have the inverse S-shape observed in studies of outcome probabilities (i.e. $\gamma \geq 1$). Unlike most studies that investigate this curve where the probability refers directly to the reward, in this case the probability of a reward is the joint probability of p(Fractal)*p(chosen Fractal's reward). The probability depicted here is captures attribute weight when computing the value of a bundle.

```{r}
tmp = par_ests %>%
  group_by(subnum, par) %>%
  summarise(est = mean(value), .groups='keep') %>%
  filter(par != "beta" & par != "alpha") %>%
  spread(par, est)

tmp = do.call("rbind", replicate(11, tmp, simplify = FALSE)) %>%
  arrange(subnum) %>%
  ungroup() %>%
  mutate(pFrac = rep(seq(0, 1, .1), 25), 
         wpFrac = (delta*pFrac^gamma)/(delta*pFrac^gamma + (1-pFrac)^gamma)) 

tmp %>%
  mutate(delta_gt_1 = ifelse(delta>=1, "delta >= 1", "delta < 1 "),
         gamma_gt_1 = ifelse(gamma>=1,"gamma >= 1", "gamma < 1")) %>%
  ggplot(aes(pFrac, wpFrac, group=subnum))+
  geom_line(aes(col = as.factor(gamma_gt_1), linetype=as.factor(delta_gt_1)))+
  geom_abline(slope=1, intercept=0, linetype="dashed")+
  labs(x="p(Fractal)", y="w(pFractal)", title="Distortion of p(Fractal)", color = element_blank(), linetype=element_blank())+
  scale_color_manual(values=c(cbbPalette[3], cbbPalette[7]))+
  theme(legend.position = "bottom")
```

```{r echo=FALSE}
rm(tmp)
```

# Determinants of bias

Is the over-reliance on the description-based attribute due to distortion of the probability that the reward will depend on the experience-based attribute or the distortion of the experience-based attributes value?

To see if the degree to which a subject used the EV difference even when it 

Random effects analysis 

did not find any systematic relationship. This is an underpowered analysis.

```{r eval=FALSE}
if(file.exists(paste0(helpers_path, 'logitOut_choiceLeft_randomEffects.RDS'))){
  out_choiceLeft = readRDS(paste0(helpers_path, 'logitOut_choiceLeft_randomEffects.RDS'))
} else {
  
  probFractalDrawVals = unique(clean_beh_data$probFractalDraw)
  conflictTrialTypes = unique(clean_beh_data$conflictTrial)
  out_choiceLeft = data.frame(Estimate=NA, Est.Error=NA, Q2.5=NA, Q97.5=NA, subnum=NA, var=NA, probFractalDraw=NA, conflictTrial=NA)

  for(i in 1:length(probFractalDrawVals)){
    curProbFractalDraw = probFractalDrawVals[i]
    
    dat = clean_beh_data %>%
      filter(probFractalDraw == curProbFractalDraw)
    
    for(j in 1:length(conflictTrialTypes)){
      
      curConflictTrial = conflictTrialTypes[j]
      
      m = brm(choiceLeft ~ (1 + leftQVAdv + leftEVAdv |subnum),
              data=dat %>% filter(conflictTrial==curConflictTrial), family=bernoulli(link="logit"), silent=2, refresh=0)
      
      intercepts = data.frame(coef(m)$subnum[,,1]) %>%
        mutate(subnum = row.names(.),
               var = "intercept",
               probFractalDraw = curProbFractalDraw,
               conflictTrial = curConflictTrial)
      
      qv_slopes = data.frame(coef(m)$subnum[,,2]) %>%
        mutate(subnum = row.names(.),
               var = "qv_slopes",
               probFractalDraw = curProbFractalDraw,
               conflictTrial = curConflictTrial)
      
      ev_slopes = data.frame(coef(m)$subnum[,,3]) %>%
        mutate(subnum = row.names(.),
               var = "ev_slopes",
               probFractalDraw = curProbFractalDraw,
               conflictTrial = curConflictTrial)
      
      out_choiceLeft = rbind(out_choiceLeft, intercepts, qv_slopes, ev_slopes)
    }
  }
  
  out_choiceLeft = out_choiceLeft %>%
    drop_na()
  
  saveRDS(out_choiceLeft, paste0(helpers_path, 'logitOut_choiceLeft_randomEffects.RDS'))
  rm(dat, m, conflictTrialTypes, curConflictTrial, probFractalDrawVals, curProbFractalDraw)
}
out_choiceLeft_re = out_choiceLeft
```

```{r eval=FALSE}
out_choiceLeft_re %>%
  filter(var %in% c("qv_slopes", "ev_slopes")) %>%
  mutate(probFractalDraw = as.factor(probFractalDraw),
         var = ifelse(var == "ev_slopes", "EV(left)-EV(right)", "QV(left)-QV(right)")) %>%
  ggplot(aes(probFractalDraw, Estimate, color=var, shape=var))+
  geom_point()+
  # geom_errorbar(aes(ymin=Q2.5, ymax=Q97.5), width=.1)+
  geom_hline(aes(yintercept=0), linetype="dashed")+
  facet_grid(conflictTrial~.)+
  theme(legend.position = "bottom")+
  labs(color="", shape="", x="p(Fractal)", y="Logit slope estimate (DV = choiceLeft)")+
  scale_color_manual(values=c(cbbPalette[2], cbbPalette[1]))
```

```{r eval=FALSE}
clean_beh_data %>%
  mutate(leftFractalAdv = fractalLeftProb - fractalRightProb,
         fractalTrueVsEst = leftFractalAdv-leftQVAdv) %>%  
  group_by(subnum, probFractalDraw, conflictTrial) %>%
  summarise(fractalValDiffSd = sd(fractalTrueVsEst),
            .groups='keep') %>%
  left_join(out_choiceLeft_re %>%
              filter(var %in% c("qv_slopes", "ev_slopes")) %>%
              select(Estimate, subnum, var, probFractalDraw, conflictTrial) %>%
              spread(var, Estimate), by=c("subnum", "probFractalDraw","conflictTrial")) %>%
  gather(var, slope, -subnum, -probFractalDraw, -conflictTrial, -fractalValDiffSd) %>%
  mutate(probFractalDraw = as.factor(probFractalDraw)) %>%
  ggplot(aes(fractalValDiffSd, slope, color=var))+
  # geom_point()+
  geom_smooth(method="lm", formula="y~x",fullrange=T)+
  facet_grid(conflictTrial~probFractalDraw)+
  theme(legend.position="bottom")+
  labs(color="", y="Logit Slope Estimate", x = "Variance of fractal value distribution")+
  scale_color_manual(values=c(cbbPalette[2], cbbPalette[1]))
```



```{r}
clean_beh_data %>%
  mutate(leftFractalAdv = fractalLeftProb - fractalRightProb,
         fractalLeftOverest = leftQVAdv-leftFractalAdv) %>%
  ggplot(aes(fractalLeftOverest, choiceLeft))+
  geom_smooth(formula = 'y~x', method = "glm", method.args = list(family=binomial), fullrange=TRUE)+
  facet_grid(conflictTrial~probFractalDraw)
  
```

```{r}
clean_beh_data %>%
  mutate(leftFractalAdv = fractalLeftProb - fractalRightProb,
         fractalLeftOverest = leftQVAdv-leftFractalAdv, 
         pFracDistortion = wpFrac - probFractalDraw) %>%
  select(subnum, fractalLeftOverest, pFracDistortion, probFractalDraw, conflictTrial, choiceLeft) %>% 
  gather(key, distortion, -subnum, -probFractalDraw, -conflictTrial, -choiceLeft) %>%
  ggplot(aes(distortion, choiceLeft, color=key))+
  geom_smooth(formula = 'y~x', method = "glm", method.args = list(family=binomial), fullrange=TRUE)+
  facet_grid(conflictTrial~probFractalDraw)+
  theme(legend.position = "bottom")+
  scale_color_manual(values=c(cbbPalette[3], cbbPalette[7]))
```

# Response times