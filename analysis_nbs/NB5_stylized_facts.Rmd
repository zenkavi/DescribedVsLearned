---
title: "Experience vs. description based decision-making project: Stylized facts"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: 'hide'
---

Set up environment and load in data

```{r include=FALSE}
library(tidyverse)
library(gridExtra)
library(brms)
library(here)
cbbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
# theme_set(theme_bw())
theme_set(theme_classic())
sem <- function(x) {sd(x, na.rm=T) / sqrt(length(x))}
helpers_path = here('helpers/')
```

```{r}
source(paste0(helpers_path, 'save_imaging_events_wBestRpe.R'))
```

# Stylized facts

## Response times 

### RT by relevant attribute

Subjects choose faster when reward depends only on fractals.

```{r}
clean_beh_data %>%
  mutate(log_rt = log(reactionTime), 
         probFractalDraw = as.factor(probFractalDraw)) %>%
  group_by(subnum, probFractalDraw) %>%
  summarise(mean_log_rt = mean(log_rt), .groups='keep') %>%
  ungroup()%>%
  group_by(probFractalDraw)%>%
  summarise(sem_log_rt = sem(mean_log_rt),
            mean_log_rt = mean(mean_log_rt)) %>%
  ggplot(aes(probFractalDraw, mean_log_rt))+
  geom_bar(stat="identity")+
  geom_errorbar(aes(ymin=  mean_log_rt - sem_log_rt, ymax=mean_log_rt + sem_log_rt), width=.2)
```

Same result as above but plotting it using raw rts instead of log rts.

Subjects choose faster the less uncertainty there is about what the reward depends on.

But why might they be additionally faster when the reward depends only on the fractals?

Based on prior psychometric curves we know that when pFrac = 1 choice depends on the QV difference but not the EV difference. So is recall of cached fractal value is faster than EV computation?


```{r}
clean_beh_data %>%
  mutate(probFractalDraw = as.factor(probFractalDraw)) %>%
  group_by(subnum, probFractalDraw) %>%
  summarise(mean_rt = mean(reactionTime), .groups='keep') %>%
  ungroup()%>%
  group_by(probFractalDraw)%>%
  summarise(sem_rt = sem(mean_rt),
            mean_rt = mean(mean_rt)) %>%
  ggplot(aes(probFractalDraw, mean_rt))+
  geom_bar(stat="identity")+
  geom_errorbar(aes(ymin=  mean_rt - sem_rt, ymax=mean_rt + sem_rt), width=.2)

```
Above plots with subjective probability

```{r}
clean_beh_data %>%
  mutate(wpFracBin = as.factor(round(wpFrac,1)),
         log_rt = log(reactionTime)) %>%
  group_by(subnum, wpFracBin) %>%
  summarise(mean_rt = mean(reactionTime), 
            mean_log_rt = mean(log_rt),.groups='keep') %>%
  ungroup()%>%
  gather(key, value, -subnum, -wpFracBin) %>%
  group_by(wpFracBin, key)%>%
  summarise(sem_rt = sem(value),
            mean_rt = mean(value),.groups = 'keep') %>%
  ggplot(aes(wpFracBin, mean_rt))+
  geom_bar(stat="identity")+
  geom_errorbar(aes(ymin=  mean_rt - sem_rt, ymax=mean_rt + sem_rt), width=.2)+
  labs(x="Subjective probFractalDraw")+
  facet_grid(key~., scales='free_y')
```

### RT by bundle value difference

```{r}
clean_beh_data %>%
  filter(abs(round(leftBundleValAdv, 1)) < .8) %>%
  mutate(probFractalDraw = as.factor(probFractalDraw),
         leftBundleValAdvBin = as.factor(round(leftBundleValAdv, 1)),
         log_rt = log(reactionTime)) %>%
  group_by(subnum, probFractalDraw, leftBundleValAdvBin) %>%
  summarise(.groups='keep',
            mean_log_rt = mean(log_rt)) %>%
  ungroup() %>%
  group_by(probFractalDraw, leftBundleValAdvBin) %>%
  summarise(.groups='keep',
            sem_log_rt = sem(mean_log_rt),
            mean_log_rt = mean(mean_log_rt)) %>%
  drop_na()%>%
  mutate(facetGroup = ifelse(as.numeric(as.character(probFractalDraw))<.6, "pFrac < .6","pFrac > .5")) %>%
  mutate(leftBundleValAdvBin = as.numeric(as.character(leftBundleValAdvBin)))%>%
  ggplot(aes(leftBundleValAdvBin, mean_log_rt, color=probFractalDraw))+
  geom_smooth(method = "lm", formula = y ~ x + I(x^2), alpha=.1)+
  facet_wrap(~facetGroup)+
  theme(legend.position = "bottom")+
  guides(color=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values=c(cbbPalette[1:5], "black", cbbPalette[5:1]))+
  annotate(geom="text", label="Right better",x=-0.5, y=-0.5)+
  annotate(geom="text", label="Left better",x=0.5, y=-0.5)+
  labs(x="Left Bundle Value - Right Bundle Value")
```

```{r}
clean_beh_data %>%
  # filter(abs(round(leftBundleValAdv, 1)) < .8) %>%
  mutate(probFractalDraw = as.factor(probFractalDraw),
         leftBundleValAdvBin = as.factor(round(leftBundleValAdv, 1)),
         log_rt = log(reactionTime)) %>%
  group_by(subnum, probFractalDraw, leftBundleValAdvBin) %>%
  summarise(.groups='keep',
            mean_log_rt = mean(log_rt)) %>%
  ungroup() %>%
  group_by(probFractalDraw, leftBundleValAdvBin) %>%
  summarise(.groups='keep',
            sem_log_rt = sem(mean_log_rt),
            mean_log_rt = mean(mean_log_rt)) %>%
  mutate(facetGroup = ifelse(as.numeric(as.character(probFractalDraw))<.6, "pFrac < .6","pFrac > .5")) %>%
  drop_na()%>%
  ggplot(aes(leftBundleValAdvBin, mean_log_rt, color=probFractalDraw))+
  geom_line(aes(group=probFractalDraw))+
  geom_errorbar(aes(ymin= mean_log_rt-sem_log_rt, ymax=mean_log_rt+sem_log_rt), width=.2, alpha=.3)+
  facet_wrap(~facetGroup)+
  theme(legend.position = "bottom")+
  guides(color=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values=c(cbbPalette[1:5], "black", cbbPalette[5:1]))
```
### RT by attribute value difference

Does RT depend similarly on the EV and QV difference (relative preference for each attribute) at each level of prob fractal draw?

```{r}
clean_beh_data %>%
  mutate(log_rt = log(reactionTime),
         leftEVAdvBin = as.factor(round(leftEVAdv,1))) %>%
  group_by(subnum, leftEVAdvBin, probFractalDraw) %>%
  summarise(.groups='keep',
            mean_log_rt = mean(log_rt)) %>%
  ungroup() %>%
  group_by(leftEVAdvBin, probFractalDraw) %>%
  summarise(.groups='keep',sem_log_rt = sem(mean_log_rt),
            mean_log_rt = mean(mean_log_rt)) %>%
  gather(key, value, -sem_log_rt, -mean_log_rt,-probFractalDraw) %>%
  rbind(clean_beh_data %>%
          mutate(log_rt = log(reactionTime),
                 leftQVAdvBin = as.factor(round(leftQVAdv,1))) %>%
          group_by(subnum, leftQVAdvBin, probFractalDraw) %>%
          summarise(.groups='keep',
                    mean_log_rt = mean(log_rt)) %>%
          ungroup() %>%
          group_by(leftQVAdvBin, probFractalDraw) %>%
          summarise(.groups='keep',sem_log_rt = sem(mean_log_rt),
                    mean_log_rt = mean(mean_log_rt)) %>%
          drop_na() %>%
          gather(key, value, -sem_log_rt, -mean_log_rt, -probFractalDraw)) %>%
  mutate(probFractalDraw=as.factor(probFractalDraw),
         value = as.numeric(as.character(value)))%>%
  ggplot(aes(value, mean_log_rt, color=probFractalDraw))+
  geom_smooth(method = "lm", formula = y ~ x + I(x^2), alpha=.1)+
  facet_wrap(~key)+
  theme(legend.position = "bottom")+
  guides(color=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values=c('#40004b','#762a83','#9970ab','#c2a5cf','#e7d4e8','#f7f7f7','#d9f0d3','#a6dba0','#5aae61','#1b7837','#00441b'))+
  annotate(geom="text", label="Right better",x=-0.5, y=-0.5)+
  annotate(geom="text", label="Left better",x=0.5, y=-0.5)+
  labs(x="Attribute Value Difference")
```

```{r}
clean_beh_data %>%
  mutate(log_rt = log(reactionTime),
         leftEVAdvBin = as.factor(round(leftEVAdv,1))) %>%
  group_by(subnum, leftEVAdvBin, probFractalDraw) %>%
  summarise(.groups='keep',
            mean_log_rt = mean(log_rt)) %>%
  ungroup() %>%
  group_by(leftEVAdvBin, probFractalDraw) %>%
  summarise(.groups='keep',sem_log_rt = sem(mean_log_rt),
            mean_log_rt = mean(mean_log_rt)) %>%
  gather(key, value, -sem_log_rt, -mean_log_rt,-probFractalDraw) %>%
  rbind(clean_beh_data %>%
          mutate(log_rt = log(reactionTime),
                 leftQVAdvBin = as.factor(round(leftQVAdv,1))) %>%
          group_by(subnum, leftQVAdvBin, probFractalDraw) %>%
          summarise(.groups='keep',
                    mean_log_rt = mean(log_rt)) %>%
          ungroup() %>%
          group_by(leftQVAdvBin, probFractalDraw) %>%
          summarise(.groups='keep',sem_log_rt = sem(mean_log_rt),
                    mean_log_rt = mean(mean_log_rt)) %>%
          drop_na() %>%
          gather(key, value, -sem_log_rt, -mean_log_rt, -probFractalDraw)) %>%
  mutate(probFractalDraw=as.factor(probFractalDraw))%>%
  ggplot(aes(value, mean_log_rt, color=probFractalDraw))+
  geom_line(aes(group=probFractalDraw))+
  # geom_errorbar(aes(ymin=mean_log_rt-sem_log_rt, ymax=mean_log_rt+sem_log_rt), width=.2)+
  facet_wrap(~key)+
  theme(legend.position = "bottom")+
  guides(color=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values=c('#40004b','#762a83','#9970ab','#c2a5cf','#e7d4e8','#f7f7f7','#d9f0d3','#a6dba0','#5aae61','#1b7837','#00441b'))
  
```

### RT by relative strength of preference

```{r}

```

## Choice

# Relative strength of preference

EV_diff/QV_diff

```{r}

```