---
title: "Experience vs. description based decision-making project: Stylized facts"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: 'hide'
---

Set up environment and load in data

```{r include=FALSE}
library(tidyverse)
library(gridExtra)
library(brms)
library(here)
cbbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
# theme_set(theme_bw())
theme_set(theme_classic())
sem <- function(x) {sd(x, na.rm=T) / sqrt(length(x))}
helpers_path = here('helpers/')
```

```{r}
source(paste0(helpers_path, 'save_imaging_events_wBestRpe.R'))
```

# Stylized facts

## Relative strength of preference

[Previously we briefly looked at](https://zenkavi.github.io/DescribedVsLearned_beh/analysis_nbs/NB3_psychometrics_logits.html) how trials might be grouped as conflict vs. non-conflict. This was a crude measure because it was a binary measure that checked whether both attribute values (EV and QV) for a bundle were better than the other bundle's. But it did not take into account how relevant each attribute was for that trial's reward. For example, for a trial where the probFractalDraw is 0 the fact that the fractals point to a different bundle as the better option compared to the lotteries should not matter since they have no bearing on the trial's reward.

A more refined measure would be the relative strength of preference. Here we operationalize this as the ration of subjectively weighted absolute value differences for each attribute. It is plotted on a log scale due a long tail. Therefore 0 is where the weighted value difference ratio is 1 (no stronger relative preference across the attributes), positive values are where the ratio is >1 (relative preference for lotteries is larger than for relative preference for fractals), negative values are where the ration is <1 (relative preference for fractals is larger than that for lotteries).

```{r}
clean_beh_data = clean_beh_data %>%
  mutate(absEVDiff = abs(leftEVAdv),
         absQVDiff = abs(leftQVAdv),
         weightedAbsEVDiff = probFractalDraw*absEVDiff,
         weightedAbsQVDiff = probFractalDraw*absQVDiff,
         weightedAbsValDiffRatio = weightedAbsEVDiff/(weightedAbsQVDiff+1e-6),
         logWeightedAbsValDiffRatio = log(weightedAbsValDiffRatio+1e-5),
         log_rt = log(reactionTime)) 
```

```{r}
clean_beh_data %>%
  ggplot(aes(log(weightedAbsValDiffRatio+1e-5)))+
  geom_histogram(bins=30)+
  geom_vline(aes(xintercept=0), linetype="dashed", color="dark red")+
  annotate(geom = "text", label = "Stronger fractal \nrelative preference", x=-8, y=1000)+
  annotate(geom = "text", label = "Stronger lottery \nrelative preference", x=8, y=1000)
```
Few subjects have more than half of their trial with stronger fractal relative preference. For most subjects there are more trials where the relative preference for lotteries is stronger.

```{r}
clean_beh_data %>%
  mutate(logWeightedAbsValDiffRatio = log(weightedAbsValDiffRatio+1e-5),
         fractalRelativePref = ifelse(logWeightedAbsValDiffRatio<0, 1, 0)) %>%
  group_by(subnum) %>%
  summarise(propFractalRelativePref = round(sum(fractalRelativePref)/n(), 2)) %>%
  ggplot(aes(propFractalRelativePref))+
  geom_histogram(bins=10)+
  geom_vline(aes(xintercept=0.5), linetype="dashed", color="dark red", size=1.5)+
  xlab("Proportion of trials with stronger relative preference between fractals")
```

## Response times 

### RT by attribute relevance

Subjects choose faster when reward depends only on fractals.

```{r}
clean_beh_data %>%
  mutate(probFractalDraw = as.factor(probFractalDraw)) %>%
  group_by(subnum, probFractalDraw) %>%
  summarise(mean_log_rt = mean(log_rt), .groups='keep') %>%
  ungroup()%>%
  group_by(probFractalDraw)%>%
  summarise(sem_log_rt = sem(mean_log_rt),
            mean_log_rt = mean(mean_log_rt)) %>%
  ggplot(aes(probFractalDraw, mean_log_rt))+
  geom_point()+
  geom_errorbar(aes(ymin=  mean_log_rt - sem_log_rt, ymax=mean_log_rt + sem_log_rt), width=.2)
```

Subjects choose faster the less uncertainty there is about what the reward depends on.

But why might they be additionally faster when the reward depends only on the fractals?

Based on prior psychometric curves we know that when pFrac = 1 choice depends on the QV difference but not the EV difference. So is recall of cached fractal value is faster than EV computation?

If for trials where the reward depends only on fractals the decision is being made before the stimuli are event presented (because they are being looked up from memory) then information presented on the stimulus screen should not affect response times.**But nothing is really presented about the fractals on the stimulus screen so the Q value dependence of RTs for pFrac=1 (see plot below) trials should not completely rule out this possibility**

### RT by attribute value difference

Does RT depend similarly on the EV and QV difference (relative preference for each attribute) at each level of prob fractal draw?

```{r}
clean_beh_data %>%
  select(log_rt, leftEVAdv,leftQVAdv, probFractalDraw) %>%
  gather(key, value, -log_rt, -probFractalDraw) %>%
  mutate(probFractalDraw=as.factor(probFractalDraw),
         value = as.numeric(as.character(value)))%>%
  ggplot(aes(abs(value), log_rt, color=probFractalDraw))+
  geom_smooth(method = "lm", formula = y ~ x, alpha=.1)+
  facet_wrap(~key, scales='free_x')+
  theme(legend.position = "bottom")+
  guides(color=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values=c('#40004b','#762a83','#9970ab','#c2a5cf','#e7d4e8','#f7f7f7','#d9f0d3','#a6dba0','#5aae61','#1b7837','#00441b'))+
  labs(x="Absolute Attribute Value Difference")
```
- For pFrac = 1 the slope is <0 for the QV difference and 0 for the EV difference.
- For pFrac != 1 the slopes for the QV difference are 0.
- For pFrac != 1 the slope for the EV difference are <0 but decreasingly so as pFrac increases.

```{r}
tmp = clean_beh_data %>% mutate(pFracOne = as.factor(ifelse(probFractalDraw == 1, 1, 0)))

m = brm(log_rt ~ probFractalDraw + pFracOne +
          abs(leftEVAdv) +  abs(leftQVAdv) + 
          probFractalDraw:abs(leftEVAdv) + probFractalDraw:abs(leftQVAdv) + 
          pFracOne:abs(leftEVAdv) + pFracOne:abs(leftQVAdv) + 
          (1|subnum), 
        data=tmp, silent=2, refresh=0)
```

```{r}
summary(m)
```

### RT by relative strength of preference

When probFractalDraw = 0 there is no variance in val diff ratio

```{r}
clean_beh_data %>%
  mutate(probFractalDraw=as.factor(probFractalDraw)) %>%
  # filter(probFractalDraw == "0") %>%
  filter(probFractalDraw == "1") %>%
  select(probFractalDraw,logWeightedAbsValDiffRatio, log_rt)
  ggplot(aes(logWeightedAbsValDiffRatio, log_rt, color=probFractalDraw))+
  geom_smooth(method = "lm", formula = y ~ x , alpha=.1)+
  theme(legend.position = "bottom")+
  guides(color=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values=c('#762a83','#9970ab','#c2a5cf','#e7d4e8','#f7f7f7','#d9f0d3','#a6dba0','#5aae61','#1b7837','#00441b'))+
  annotate(geom="text", label="Bigger fractal difference",x=-8, y=-0.2)+
  annotate(geom="text", label="Bigger lottery difference",x=8, y=-0.2)
```

Does the relative preference for both attributes affect RT the same way?

```{r}
clean_beh_data %>%
  mutate(weightedAbsEVDiff = (1-probFractalDraw)*abs(leftEVAdv),
         weightedAbsQVDiff = (probFractalDraw)*abs(leftQVAdv)) %>%
  mutate(weightedAbsEVDiff = as.factor(weightedAbsEVDiff)) %>%
  group_by(weightedAbsEVDiff, subnum) %>%
  summarise(.groups='keep',
            meanWeightedAbsQVDiff = mean(weightedAbsQVDiff)) %>%
  ungroup() %>%
  group_by(weightedAbsEVDiff) %>%
  summarise(semWeightedAbsQVDiff = sem(meanWeightedAbsQVDiff),
            meanWeightedAbsQVDiff = mean(meanWeightedAbsQVDiff)) %>%
  ggplot(aes(weightedAbsEVDiff, meanWeightedAbsQVDiff))+
  geom_point()+
  geom_errorbar(aes(ymin = meanWeightedAbsQVDiff - semWeightedAbsQVDiff, 
                    ymax = meanWeightedAbsQVDiff + semWeightedAbsQVDiff), width=.2)
```

```{r}
clean_beh_data %>%
  mutate(weightedAbsEVDiff = (1-probFractalDraw)*abs(leftEVAdv),
         weightedAbsQVDiff = (probFractalDraw)*abs(leftQVAdv)) %>%
  mutate(weightedAbsEVDiff = as.factor(weightedAbsEVDiff)) %>%
  filter(weightedAbsEVDiff == "0.18") %>%
  select(weightedAbsEVDiff, weightedAbsQVDiff, probFractalDraw, leftEVAdv, leftQVAdv)
```

```{r}
clean_beh_data %>%
  mutate(weightedAbsEVDiff = (1-probFractalDraw)*abs(leftEVAdv),
         weightedAbsQVDiff = (probFractalDraw)*abs(leftQVAdv),
         probFractalDraw = as.factor(probFractalDraw)) %>%
  select(weightedAbsEVDiff, weightedAbsQVDiff, log_rt, probFractalDraw) %>%
  gather(key, value, -log_rt, -probFractalDraw) %>%
  ggplot(aes(value, log_rt, color=probFractalDraw))+
  geom_smooth(method = "lm", formula = y ~ x, alpha=.1)+
  facet_wrap(~key)+
  theme(legend.position = "bottom")+
  guides(color=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values=c('#40004b','#762a83','#9970ab','#c2a5cf','#e7d4e8','#f7f7f7','#d9f0d3','#a6dba0','#5aae61','#1b7837','#00441b'))+
  xlab("")
```

## Choice

Logit by relative strength of preference

```{r}
m = brm(choseBetterLottery ~ probFractalDraw + logWeightedAbsValDiffRatio + (1|subnum),
            data=clean_beh_data, family=bernoulli(link="logit"), silent=2, refresh=0)
```

```{r}
summary(m)
```

